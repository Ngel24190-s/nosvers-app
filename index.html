<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NosVers ¬∑ Gestion Agro√©cologique</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Space+Grotesk:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --sol: #1a3a1e;
  --sol-mid: #2d5c35;
  --sol-light: #4a7c59;
  --terre: #3d2b1f;
  --terre-mid: #6b4423;
  --humus: #8b6014;
  --humus-light: #c49a3c;
  --cr√®me: #f4efe3;
  --sable: #e8dcc4;
  --ver: #5d4037;
  --ver-light: #8d6e63;
  --blanc: #fdfaf4;
  --texte: #1c1510;
  --texte-doux: #5a4e42;
  --compost-col: #c45c00;
  --animaux-col: #7b3f00;
  --huerto-col: #2e6b30;
  --vers-col: #6b3a2a;
  --r: 10px;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html { scroll-behavior: smooth; }

body {
  font-family: 'Space Grotesk', sans-serif;
  background: var(--cr√®me);
  color: var(--texte);
  min-height: 100vh;
  overflow-x: hidden;
}

/* BG texture */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    url("data:image/svg+xml,%3Csvg width='80' height='80' viewBox='0 0 80 80' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%234a7c59' fill-opacity='0.03'%3E%3Cpath d='M50 50c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10c0 5.523-4.477 10-10 10s-10-4.477-10-10 4.477-10 10-10zM10 10c0-5.523 4.477-10 10-10s10 4.477 10 10-4.477 10-10 10c0 5.523-4.477 10-10 10S0 25.523 0 20s4.477-10 10-10z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 0;
}

/* ============ HEADER ============ */
.header {
  background: var(--sol);
  color: var(--cr√®me);
  padding: 0 2rem;
  height: 64px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 200;
  box-shadow: 0 4px 30px rgba(26,58,30,0.3);
}

.logo {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo-mark {
  width: 36px;
  height: 36px;
  background: var(--sol-light);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
}

.logo-text {
  font-family: 'Playfair Display', serif;
  font-size: 1.5rem;
  letter-spacing: 0.02em;
}

.logo-sub {
  font-size: 0.65rem;
  opacity: 0.5;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  font-weight: 500;
  display: block;
  margin-top: -2px;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.header-date {
  font-size: 0.78rem;
  opacity: 0.55;
  text-align: right;
  line-height: 1.5;
}

.status-pill {
  display: flex;
  align-items: center;
  gap: 6px;
  background: rgba(74,124,89,0.2);
  border: 1px solid rgba(74,124,89,0.3);
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.7rem;
  font-weight: 600;
  letter-spacing: 0.06em;
}

.dot-live {
  width: 7px; height: 7px;
  background: #6db070;
  border-radius: 50%;
  animation: pulse 2.2s ease-in-out infinite;
}

@keyframes pulse {
  0%,100% { opacity:1; transform: scale(1); }
  50% { opacity: 0.4; transform: scale(0.85); }
}

/* ============ NAV TABS ============ */
.nav-tabs {
  background: var(--terre);
  display: flex;
  overflow-x: auto;
  scrollbar-width: none;
  border-bottom: 2px solid rgba(255,255,255,0.06);
  position: sticky;
  top: 64px;
  z-index: 190;
}

.nav-tabs::-webkit-scrollbar { display: none; }

.nav-tab {
  padding: 0 1.5rem;
  height: 46px;
  display: flex;
  align-items: center;
  gap: 8px;
  color: rgba(244,239,227,0.5);
  font-size: 0.8rem;
  font-weight: 600;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.25s;
  border-bottom: 3px solid transparent;
  border-top: 3px solid transparent;
  background: none;
  border-left: none;
  border-right: none;
}

.nav-tab:hover { color: var(--cr√®me); }

.nav-tab.active {
  color: var(--cr√®me);
  border-bottom-color: var(--sol-light);
  background: rgba(74,124,89,0.1);
}

/* ============ MAIN LAYOUT ============ */
.main {
  position: relative;
  z-index: 1;
  max-width: 1000px;
  margin: 0 auto;
  padding: 2rem 1.5rem 5rem;
}

/* ============ SECTIONS ============ */
.section { display: none; }
.section.active { display: block; animation: fadeUp 0.4s ease; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(18px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ============ SECTION HEADER ============ */
.section-header {
  margin-bottom: 2rem;
}

.section-title {
  font-family: 'Playfair Display', serif;
  font-size: 2rem;
  font-weight: 700;
  color: var(--sol);
  line-height: 1.15;
}

.section-title em {
  font-style: italic;
  color: var(--sol-light);
}

.section-sub {
  color: var(--texte-doux);
  font-size: 0.85rem;
  margin-top: 0.35rem;
  font-weight: 400;
}

/* ============ CARDS GRID ============ */
.cards-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.card-agent {
  background: var(--blanc);
  border-radius: var(--r);
  overflow: hidden;
  box-shadow: 0 2px 16px rgba(26,58,30,0.06);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  border: 2px solid transparent;
  position: relative;
}

.card-agent:hover {
  transform: translateY(-5px) scale(1.01);
  box-shadow: 0 12px 40px rgba(26,58,30,0.14);
}

.card-agent.selected {
  border-color: var(--sol-light);
  box-shadow: 0 0 0 4px rgba(74,124,89,0.15);
}

.card-agent.loading {
  pointer-events: none;
  opacity: 0.8;
}

.card-top {
  padding: 1.3rem 1.3rem 1rem;
  display: flex;
  align-items: flex-start;
  gap: 12px;
}

.card-icon {
  width: 44px; height: 44px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.3rem;
  flex-shrink: 0;
}

.card-info { flex: 1; }

.card-name {
  font-family: 'Playfair Display', serif;
  font-size: 1.15rem;
  font-weight: 700;
  color: var(--texte);
  line-height: 1.2;
}

.card-desc {
  font-size: 0.73rem;
  color: var(--texte-doux);
  margin-top: 3px;
  line-height: 1.4;
}

.card-bar {
  height: 4px;
  width: 100%;
}

/* couleurs par domaine */
.domain-compost .card-icon { background: rgba(196,92,0,0.12); color: var(--compost-col); }
.domain-compost .card-bar { background: var(--compost-col); }
.domain-compost.selected { border-color: var(--compost-col); }

.domain-animaux .card-icon { background: rgba(123,63,0,0.12); color: var(--animaux-col); }
.domain-animaux .card-bar { background: var(--animaux-col); }
.domain-animaux.selected { border-color: var(--animaux-col); }

.domain-huerto .card-icon { background: rgba(46,107,48,0.1); color: var(--huerto-col); }
.domain-huerto .card-bar { background: var(--huerto-col); }
.domain-huerto.selected { border-color: var(--huerto-col); }

.domain-vers .card-icon { background: rgba(107,58,42,0.1); color: var(--vers-col); }
.domain-vers .card-bar { background: var(--vers-col); }
.domain-vers.selected { border-color: var(--vers-col); }

/* ============ INPUT ZONE ============ */
.query-zone {
  background: var(--blanc);
  border-radius: var(--r);
  padding: 1.2rem;
  margin-bottom: 1.5rem;
  box-shadow: 0 2px 12px rgba(26,58,30,0.05);
  display: flex;
  gap: 10px;
  align-items: center;
}

.query-input {
  flex: 1;
  border: 2px solid var(--sable);
  border-radius: 8px;
  padding: 0.75rem 1rem;
  font-family: 'Space Grotesk', sans-serif;
  font-size: 0.88rem;
  background: var(--cr√®me);
  transition: all 0.22s;
  color: var(--texte);
}

.query-input:focus {
  outline: none;
  border-color: var(--sol-light);
  background: white;
  box-shadow: 0 0 0 4px rgba(74,124,89,0.1);
}

.query-input::placeholder { color: #bbb0a0; }

.btn-query {
  padding: 0.75rem 1.5rem;
  background: var(--sol);
  color: var(--cr√®me);
  border: none;
  border-radius: 8px;
  font-family: 'Space Grotesk', sans-serif;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.22s;
  white-space: nowrap;
}

.btn-query:hover { background: var(--sol-mid); transform: translateY(-1px); }
.btn-query:disabled { opacity: 0.5; pointer-events: none; }

/* ============ RESPONSE PANEL ============ */
.response-panel {
  display: none;
  background: var(--blanc);
  border-radius: var(--r);
  box-shadow: 0 2px 24px rgba(26,58,30,0.08);
  overflow: hidden;
  margin-bottom: 1.5rem;
}

.response-panel.visible {
  display: block;
  animation: slideUp 0.35s ease;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(14px); }
  to { opacity: 1; transform: translateY(0); }
}

.resp-header {
  padding: 1rem 1.4rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--sable);
}

.resp-domain {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 700;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.resp-domain-dot {
  width: 10px; height: 10px;
  border-radius: 3px;
}

.resp-meta {
  font-size: 0.7rem;
  color: var(--texte-doux);
  opacity: 0.6;
}

.resp-body {
  padding: 1.4rem;
  font-size: 0.9rem;
  line-height: 1.8;
  color: var(--texte);
  max-height: 520px;
  overflow-y: auto;
  white-space: pre-wrap;
}

.resp-body::-webkit-scrollbar { width: 5px; }
.resp-body::-webkit-scrollbar-track { background: var(--sable); }
.resp-body::-webkit-scrollbar-thumb { background: var(--sol-light); border-radius: 4px; }

.resp-footer {
  padding: 0.9rem 1.4rem;
  border-top: 1px solid var(--sable);
  display: flex;
  gap: 0.6rem;
  flex-wrap: wrap;
  align-items: center;
}

.btn-action {
  padding: 0.5rem 1.1rem;
  border-radius: 7px;
  font-family: 'Space Grotesk', sans-serif;
  font-size: 0.78rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 0.03em;
}

.btn-primary {
  background: var(--sol);
  color: var(--cr√®me);
  border: 2px solid var(--sol);
}
.btn-primary:hover { background: var(--sol-mid); }
.btn-primary.done {
  background: var(--sol-light);
  border-color: var(--sol-light);
  pointer-events: none;
}

.btn-secondary {
  background: transparent;
  color: var(--texte-doux);
  border: 2px solid var(--sable);
}
.btn-secondary:hover { border-color: var(--sol-light); color: var(--sol); }

/* Loading spinner inside card */
.spin {
  display: inline-block;
  width: 20px; height: 20px;
  border: 2px solid rgba(26,58,30,0.15);
  border-top-color: var(--sol);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ============ JOURNAL / REGISTROS ============ */
.log-section {
  margin-top: 2rem;
}

.log-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.2rem;
  color: var(--sol);
  margin-bottom: 1rem;
}

.log-entries {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.log-entry {
  background: var(--blanc);
  border-radius: 8px;
  padding: 0.9rem 1.1rem;
  display: grid;
  grid-template-columns: auto 1fr auto;
  align-items: center;
  gap: 12px;
  font-size: 0.82rem;
  box-shadow: 0 1px 6px rgba(26,58,30,0.04);
  transition: all 0.2s;
  animation: fadeUp 0.3s ease;
}

.log-entry:hover {
  transform: translateX(3px);
  box-shadow: 0 2px 12px rgba(26,58,30,0.09);
}

.log-domain-tag {
  padding: 3px 9px;
  border-radius: 5px;
  font-size: 0.68rem;
  font-weight: 700;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: white;
}

.log-text { color: var(--texte-doux); }
.log-time { opacity: 0.45; white-space: nowrap; }

.log-empty {
  text-align: center;
  padding: 2.5rem;
  color: var(--texte-doux);
  opacity: 0.5;
  font-size: 0.85rem;
  background: var(--blanc);
  border-radius: var(--r);
}

/* ============ FICHES SECTION ============ */
.fiches-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1rem;
}

.fiche {
  background: var(--blanc);
  border-radius: var(--r);
  overflow: hidden;
  box-shadow: 0 2px 12px rgba(26,58,30,0.06);
}

.fiche-head {
  padding: 1rem 1.2rem 0.8rem;
  border-bottom: 3px solid;
}

.fiche-head h3 {
  font-family: 'Playfair Display', serif;
  font-size: 1.1rem;
  font-weight: 700;
}

.fiche-head p {
  font-size: 0.73rem;
  opacity: 0.6;
  margin-top: 3px;
}

.fiche-body {
  padding: 1rem 1.2rem;
}

.fiche-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.45rem 0;
  border-bottom: 1px solid var(--sable);
  font-size: 0.82rem;
}

.fiche-row:last-child { border: none; }

.fiche-label { color: var(--texte-doux); }
.fiche-val { font-weight: 600; color: var(--texte); }

.fiche-val.good { color: var(--huerto-col); }
.fiche-val.warn { color: var(--humus); }
.fiche-val.alert { color: #c0392b; }

.param-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 0.73rem;
  font-weight: 600;
  background: rgba(74,124,89,0.1);
  color: var(--sol-mid);
  margin: 3px 3px 0 0;
}

/* ============ CHECKLIST ============ */
.checklist {
  background: var(--blanc);
  border-radius: var(--r);
  box-shadow: 0 2px 12px rgba(26,58,30,0.06);
  overflow: hidden;
}

.checklist-header {
  padding: 1rem 1.4rem;
  border-bottom: 1px solid var(--sable);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.checklist-header h3 {
  font-family: 'Playfair Display', serif;
  font-size: 1.1rem;
}

.progress-bar {
  width: 100px;
  height: 6px;
  background: var(--sable);
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: var(--sol-light);
  border-radius: 4px;
  transition: width 0.4s ease;
}

.progress-text {
  font-size: 0.72rem;
  color: var(--texte-doux);
  margin-top: 3px;
  text-align: right;
}

.check-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 0.85rem 1.4rem;
  border-bottom: 1px solid rgba(232,220,196,0.5);
  cursor: pointer;
  transition: background 0.18s;
}

.check-item:last-child { border: none; }
.check-item:hover { background: rgba(74,124,89,0.04); }

.check-box {
  width: 20px; height: 20px;
  border: 2px solid var(--sable);
  border-radius: 5px;
  flex-shrink: 0;
  margin-top: 2px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  font-size: 0.75rem;
}

.check-item.done .check-box {
  background: var(--sol-light);
  border-color: var(--sol-light);
  color: white;
}

.check-item.done .check-content {
  opacity: 0.45;
  text-decoration: line-through;
}

.check-content { flex: 1; }

.check-titre {
  font-weight: 600;
  font-size: 0.84rem;
  color: var(--texte);
}

.check-detail {
  font-size: 0.74rem;
  color: var(--texte-doux);
  margin-top: 2px;
  line-height: 1.4;
}

.check-tag {
  font-size: 0.65rem;
  padding: 2px 7px;
  border-radius: 5px;
  font-weight: 700;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  color: white;
  margin-top: 4px;
  display: inline-block;
}

/* ============ INVENTAIRE ============ */
.inventory-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.inv-card {
  background: var(--blanc);
  border-radius: var(--r);
  padding: 1.2rem;
  box-shadow: 0 2px 12px rgba(26,58,30,0.06);
  text-align: center;
  transition: all 0.25s;
}

.inv-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 24px rgba(26,58,30,0.1);
}

.inv-icon { font-size: 2rem; margin-bottom: 0.5rem; }
.inv-val {
  font-family: 'Playfair Display', serif;
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--sol);
}
.inv-unit {
  font-size: 0.72rem;
  color: var(--texte-doux);
  text-transform: uppercase;
  letter-spacing: 0.08em;
}
.inv-label {
  font-size: 0.78rem;
  color: var(--texte-doux);
  margin-top: 4px;
}

/* editable inventory value */
.inv-val-input {
  font-family: 'Playfair Display', serif;
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--sol);
  border: none;
  background: transparent;
  width: 90px;
  text-align: center;
  outline: none;
  border-bottom: 2px dashed var(--sable);
  transition: border-color 0.2s;
}
.inv-val-input:focus { border-color: var(--sol-light); }

/* ============ MODAL / OVERLAY ============ */
.overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(26,58,30,0.5);
  backdrop-filter: blur(4px);
  z-index: 500;
  align-items: center;
  justify-content: center;
}

.overlay.open {
  display: flex;
  animation: fadeIn 0.25s ease;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.modal {
  background: var(--blanc);
  border-radius: 14px;
  max-width: 540px;
  width: 92%;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: 0 30px 80px rgba(26,58,30,0.25);
  animation: popUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes popUp {
  from { transform: scale(0.88); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.modal-header {
  padding: 1.5rem 1.5rem 1rem;
  border-bottom: 1px solid var(--sable);
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.modal-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.3rem;
  color: var(--sol);
}

.modal-close {
  background: var(--sable);
  border: none;
  width: 30px; height: 30px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  flex-shrink: 0;
}
.modal-close:hover { background: var(--sol-light); color: white; }

.modal-body { padding: 1.5rem; }

/* ============ RESPONSIVE ============ */
@media (max-width: 640px) {
  .cards-grid, .fiches-grid { grid-template-columns: 1fr; }
  .inventory-grid { grid-template-columns: repeat(2, 1fr); }
  .header { padding: 0 1rem; }
  .logo-text { font-size: 1.25rem; }
  .main { padding: 1.2rem 1rem 4rem; }
  .status-pill span { display: none; }
  .section-title { font-size: 1.6rem; }
}

/* ============ MOTTO BAND ============ */
.motto-band {
  background: var(--sol);
  color: rgba(244,239,227,0.55);
  text-align: center;
  padding: 6px;
  font-size: 0.7rem;
  font-style: italic;
  letter-spacing: 0.06em;
  font-family: 'Playfair Display', serif;
}

/* ============ THINKING INDICATOR ============ */
.thinking {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 1rem 1.4rem;
  color: var(--texte-doux);
  font-size: 0.83rem;
  font-style: italic;
}

.thinking-dots span {
  display: inline-block;
  width: 7px; height: 7px;
  background: var(--sol-light);
  border-radius: 50%;
  animation: bounce 1.2s ease-in-out infinite;
}
.thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
.thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes bounce {
  0%,100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}

/* ============ LOGIN ============ */
.login-screen {
  position: fixed;
  inset: 0;
  background: var(--sol);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  flex-direction: column;
  gap: 2rem;
}

.login-box {
  background: var(--cr√®me);
  border-radius: 16px;
  padding: 2.5rem 2rem;
  width: 92%;
  max-width: 360px;
  box-shadow: 0 30px 80px rgba(0,0,0,0.3);
  text-align: center;
}

.login-logo {
  font-size: 3rem;
  margin-bottom: 0.5rem;
}

.login-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.8rem;
  color: var(--sol);
  margin-bottom: 0.3rem;
}

.login-sub {
  font-size: 0.78rem;
  color: var(--texte-doux);
  margin-bottom: 2rem;
  font-style: italic;
}

.login-field {
  width: 100%;
  padding: 0.8rem 1rem;
  border: 2px solid var(--sable);
  border-radius: 8px;
  font-family: 'Space Grotesk', sans-serif;
  font-size: 0.9rem;
  background: white;
  margin-bottom: 0.8rem;
  transition: border-color 0.2s;
}

.login-field:focus {
  outline: none;
  border-color: var(--sol-light);
}

.login-btn {
  width: 100%;
  padding: 0.85rem;
  background: var(--sol);
  color: var(--cr√®me);
  border: none;
  border-radius: 8px;
  font-family: 'Space Grotesk', sans-serif;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
  margin-top: 0.4rem;
}

.login-btn:hover { background: var(--sol-mid); }

.login-error {
  color: #c0392b;
  font-size: 0.8rem;
  margin-top: 0.6rem;
  min-height: 1.2em;
}

.login-user-badge {
  position: fixed;
  bottom: 1rem;
  right: 1rem;
  background: var(--sol);
  color: var(--cr√®me);
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 0.72rem;
  font-weight: 600;
  z-index: 100;
  cursor: pointer;
  opacity: 0.7;
}
.login-user-badge:hover { opacity: 1; }


/* ============ √âTAT DE LA FERME ============ */
.meteo-widget {
  background: var(--sol);
  color: var(--cr√®me);
  border-radius: var(--r);
  padding: 1rem 1.3rem;
  margin-bottom: 1.2rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
  box-shadow: 0 4px 20px rgba(26,58,30,0.2);
}
.meteo-loading { opacity: 0.5; font-size: 0.82rem; font-style: italic; }
.meteo-icon { font-size: 2rem; flex-shrink: 0; }
.meteo-main { flex: 1; min-width: 120px; }
.meteo-temp { font-family: 'Playfair Display', serif; font-size: 1.6rem; font-weight: 700; }
.meteo-desc { font-size: 0.75rem; opacity: 0.7; text-transform: capitalize; margin-top: 2px; }
.meteo-details { display: flex; gap: 1rem; flex-wrap: wrap; }
.meteo-detail { text-align: center; }
.meteo-detail-val { font-weight: 700; font-size: 0.9rem; }
.meteo-detail-lbl { font-size: 0.65rem; opacity: 0.6; text-transform: uppercase; letter-spacing: 0.06em; }
.meteo-rain-alert {
  background: rgba(255,200,0,0.15);
  border: 1px solid rgba(255,200,0,0.3);
  border-radius: 6px;
  padding: 4px 10px;
  font-size: 0.75rem;
  font-weight: 600;
  color: #ffe066;
  width: 100%;
  margin-top: 4px;
}
.meteo-forecast {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.5rem;
  width: 100%;
  overflow-x: auto;
}
.meteo-forecast-item {
  background: rgba(255,255,255,0.08);
  border-radius: 6px;
  padding: 6px 10px;
  text-align: center;
  font-size: 0.72rem;
  flex-shrink: 0;
}
.meteo-forecast-item .f-hour { opacity: 0.6; margin-bottom: 2px; }
.meteo-forecast-item .f-temp { font-weight: 700; }
.meteo-forecast-item .f-rain { color: #7ec8e3; margin-top: 2px; }

.etat-section { margin-bottom: 1.5rem; }
.etat-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.1rem;
  color: var(--sol);
  margin-bottom: 0.8rem;
  display: flex;
  align-items: center;
  gap: 8px;
}
.etat-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.8rem;
}
.etat-card {
  background: var(--blanc);
  border-radius: var(--r);
  padding: 1rem;
  box-shadow: 0 2px 10px rgba(26,58,30,0.05);
  border-left: 4px solid var(--sable);
  transition: border-color 0.2s;
}
.etat-card:focus-within { border-left-color: var(--sol-light); }
.etat-card-title {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--texte-doux);
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 5px;
}
.etat-textarea {
  width: 100%;
  border: none;
  background: transparent;
  font-family: 'Space Grotesk', sans-serif;
  font-size: 0.82rem;
  color: var(--texte);
  resize: none;
  min-height: 70px;
  line-height: 1.5;
  outline: none;
}
.etat-textarea::placeholder { color: #c0b8ac; font-style: italic; }
.etat-save-btn {
  width: 100%;
  padding: 0.7rem;
  background: var(--sol);
  color: var(--cr√®me);
  border: none;
  border-radius: 8px;
  font-family: 'Space Grotesk', sans-serif;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 1rem;
}
.etat-save-btn:hover { background: var(--sol-mid); }
.etat-save-btn.saved { background: var(--sol-light); }
.context-active-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  background: rgba(74,124,89,0.12);
  border: 1px solid rgba(74,124,89,0.25);
  color: var(--sol-mid);
  font-size: 0.72rem;
  font-weight: 600;
  padding: 3px 9px;
  border-radius: 20px;
  margin-left: 8px;
}
@media (max-width: 640px) {
  .etat-grid { grid-template-columns: 1fr; }
  .meteo-details { gap: 0.6rem; }
}


/* ============ PHOTO UPLOAD ============ */
.photo-zone {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.8rem;
  align-items: center;
  flex-wrap: wrap;
}

.btn-photo {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 0.6rem 1rem;
  background: var(--blanc);
  border: 2px dashed var(--sable);
  border-radius: 8px;
  font-family: 'Space Grotesk', sans-serif;
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--texte-doux);
  cursor: pointer;
  transition: all 0.22s;
  flex: 1;
}
.btn-photo:hover {
  border-color: var(--sol-light);
  color: var(--sol);
  background: rgba(74,124,89,0.05);
}
.btn-photo.has-photo {
  border-color: var(--sol-light);
  background: rgba(74,124,89,0.08);
  color: var(--sol);
  border-style: solid;
}

.photo-preview-wrap {
  position: relative;
  display: none;
  margin-bottom: 0.8rem;
}
.photo-preview-wrap.visible { display: block; }
.photo-preview {
  width: 100%;
  max-height: 200px;
  object-fit: cover;
  border-radius: 8px;
  border: 2px solid var(--sable);
}
.photo-remove {
  position: absolute;
  top: 6px;
  right: 6px;
  background: rgba(0,0,0,0.6);
  color: white;
  border: none;
  width: 26px;
  height: 26px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 0.8rem;
  display: flex;
  align-items: center;
  justify-content: center;
}
.photo-analyzing {
  font-size: 0.78rem;
  color: var(--sol-light);
  font-style: italic;
  padding: 4px 0;
}


/* ============ PLANO HUERTO ============ */
.huerto-controls {
  display: flex;
  gap: 0.6rem;
  margin-bottom: 1.2rem;
  flex-wrap: wrap;
  align-items: center;
}
.huerto-legend {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-bottom: 1rem;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 0.72rem;
  color: var(--texte-doux);
}
.legend-dot {
  width: 12px; height: 12px;
  border-radius: 3px;
  flex-shrink: 0;
}
.huerto-grid-wrap {
  background: var(--blanc);
  border-radius: var(--r);
  padding: 1.2rem;
  box-shadow: 0 2px 12px rgba(26,58,30,0.06);
  margin-bottom: 1.2rem;
  overflow-x: auto;
}
.huerto-grid {
  display: grid;
  gap: 8px;
  min-width: 300px;
}
.parcelle {
  background: var(--cr√®me);
  border: 2px solid var(--sable);
  border-radius: 8px;
  padding: 0.7rem;
  cursor: pointer;
  transition: all 0.2s;
  min-height: 80px;
  position: relative;
}
.parcelle:hover { border-color: var(--sol-light); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(26,58,30,0.1); }
.parcelle.vide { border-style: dashed; opacity: 0.6; }
.parcelle.vide:hover { opacity: 1; }
.parcelle-num {
  font-size: 0.65rem;
  font-weight: 700;
  color: var(--texte-doux);
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 4px;
}
.parcelle-cultivo {
  font-family: 'Playfair Display', serif;
  font-size: 0.95rem;
  font-weight: 700;
  color: var(--texte);
  line-height: 1.2;
}
.parcelle-famille {
  font-size: 0.68rem;
  font-weight: 600;
  padding: 2px 6px;
  border-radius: 4px;
  margin-top: 4px;
  display: inline-block;
  color: white;
}
.parcelle-date {
  font-size: 0.68rem;
  color: var(--texte-doux);
  margin-top: 4px;
}
.parcelle-alerte {
  position: absolute;
  top: 6px; right: 6px;
  font-size: 0.75rem;
  title: "Rotation conseill√©e";
}
.rotation-warning {
  background: rgba(255,150,0,0.1);
  border: 1px solid rgba(255,150,0,0.3);
  border-radius: 8px;
  padding: 0.8rem 1rem;
  font-size: 0.82rem;
  color: #8b5500;
  margin-bottom: 1rem;
}
.rotation-warning strong { display: block; margin-bottom: 4px; }

/* Famille colors */
.fam-solanacees { background: #e74c3c; }
.fam-cucurbitacees { background: #f39c12; }
.fam-liliacees { background: #9b59b6; }
.fam-legumineuses { background: #27ae60; }
.fam-cruciferes { background: #3498db; }
.fam-apiacees { background: #1abc9c; }
.fam-asteracees { background: #e67e22; }
.fam-chenopodiaceae { background: #e91e63; }
.fam-poaceae { background: #795548; }
.fam-autre { background: #95a5a6; }
.fam-vide { background: #bdc3c7; }

/* Modal parcelle */
.parcelle-form label {
  display: block;
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--texte-doux);
  margin-bottom: 4px;
  margin-top: 0.8rem;
}
.parcelle-form input, .parcelle-form select, .parcelle-form textarea {
  width: 100%;
  padding: 0.6rem 0.8rem;
  border: 2px solid var(--sable);
  border-radius: 7px;
  font-family: 'Space Grotesk', sans-serif;
  font-size: 0.85rem;
  background: var(--cr√®me);
  transition: border-color 0.2s;
}
.parcelle-form input:focus, .parcelle-form select:focus, .parcelle-form textarea:focus {
  outline: none;
  border-color: var(--sol-light);
}
.parcelle-historique {
  margin-top: 0.8rem;
  font-size: 0.78rem;
  color: var(--texte-doux);
}
.hist-item {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  border-bottom: 1px solid var(--sable);
  font-size: 0.75rem;
}

@media (max-width: 640px) {
  .parcelle { min-height: 65px; padding: 0.5rem; }
  .parcelle-cultivo { font-size: 0.82rem; }
}


/* ============ DUAL MODE AGENTS ============ */
.mode-tabs {
  display: flex;
  gap: 0.4rem;
  margin-bottom: 1.2rem;
  background: var(--sable);
  border-radius: 10px;
  padding: 4px;
}
.mode-tab {
  flex: 1;
  padding: 0.6rem 0.8rem;
  border: none;
  border-radius: 8px;
  font-family: 'Space Grotesk', sans-serif;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  background: transparent;
  color: var(--texte-doux);
}
.mode-tab.active {
  background: var(--blanc);
  color: var(--sol);
  box-shadow: 0 2px 8px rgba(26,58,30,0.12);
}
.mode-tab:hover:not(.active) { color: var(--texte); }
.conseil-saved {
  background: rgba(74,124,89,0.08);
  border: 1px solid rgba(74,124,89,0.2);
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 0.78rem;
  color: var(--sol-mid);
  margin-top: 0.6rem;
  display: none;
}
.conseil-saved.visible { display: block; }


/* ============ DIRECTOR DE OPERACIONES ============ */
.director-card {
  background: var(--sol);
  border-radius: var(--r);
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  color: var(--cr√®me);
  box-shadow: 0 8px 32px rgba(26,58,30,0.25);
  position: relative;
  overflow: hidden;
}
.director-card::before {
  content: '';
  position: absolute;
  top: -40px; right: -40px;
  width: 150px; height: 150px;
  border-radius: 50%;
  background: rgba(255,255,255,0.04);
  pointer-events: none;
}
.director-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1rem;
  flex-wrap: wrap;
  gap: 0.5rem;
}
.director-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.3rem;
  font-weight: 400;
  display: flex;
  align-items: center;
  gap: 8px;
}
.director-meta {
  font-size: 0.72rem;
  opacity: 0.6;
}
.director-meteo-strip {
  display: flex;
  gap: 1rem;
  background: rgba(255,255,255,0.06);
  border-radius: 8px;
  padding: 0.6rem 1rem;
  margin-bottom: 1rem;
  font-size: 0.8rem;
  flex-wrap: wrap;
  align-items: center;
}
.director-meteo-item { display: flex; align-items: center; gap: 4px; opacity: 0.85; }
.director-body {
  font-size: 0.88rem;
  line-height: 1.7;
  white-space: pre-wrap;
  max-height: 500px;
  overflow-y: auto;
}
.director-body::-webkit-scrollbar { width: 4px; }
.director-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
.director-thinking {
  display: flex;
  align-items: center;
  gap: 10px;
  opacity: 0.7;
  font-style: italic;
  font-size: 0.85rem;
  padding: 1rem 0;
}
.director-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1rem;
  flex-wrap: wrap;
}
.btn-director {
  padding: 0.55rem 1.1rem;
  border-radius: 8px;
  font-family: 'Space Grotesk', sans-serif;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  border: none;
}
.btn-director-primary {
  background: var(--cr√®me);
  color: var(--sol);
}
.btn-director-primary:hover { background: white; }
.btn-director-secondary {
  background: rgba(255,255,255,0.1);
  color: var(--cr√®me);
  border: 1px solid rgba(255,255,255,0.2);
}
.btn-director-secondary:hover { background: rgba(255,255,255,0.18); }
.btn-director-secondary.done { background: rgba(255,255,255,0.2); pointer-events: none; }
.director-last {
  font-size: 0.72rem;
  opacity: 0.5;
  margin-top: 0.5rem;
  font-style: italic;
}

/* Specialist agents - conseil only */
.agents-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.8rem;
  margin-bottom: 1.2rem;
}
.agent-specialist {
  background: var(--blanc);
  border-radius: var(--r);
  border: 2px solid var(--sable);
  padding: 1rem;
  cursor: pointer;
  transition: all 0.25s;
  display: flex;
  align-items: center;
  gap: 0.7rem;
}
.agent-specialist:hover { border-color: var(--sol-light); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(26,58,30,0.1); }
.agent-specialist.active { border-color: var(--sol); background: rgba(26,58,30,0.04); }
.agent-specialist.loading { opacity: 0.6; pointer-events: none; }
.agent-spec-icon { font-size: 1.8rem; flex-shrink: 0; }
.agent-spec-info { flex: 1; min-width: 0; }
.agent-spec-name { font-weight: 700; font-size: 0.88rem; color: var(--texte); }
.agent-spec-desc { font-size: 0.72rem; color: var(--texte-doux); margin-top: 2px; }
.agent-spec-badge {
  font-size: 0.65rem;
  background: rgba(74,124,89,0.12);
  color: var(--sol-mid);
  padding: 2px 7px;
  border-radius: 10px;
  font-weight: 700;
  flex-shrink: 0;
}

@media (max-width: 640px) {
  .agents-grid { grid-template-columns: 1fr; }
  .director-card { padding: 1rem; }
}

</style>
</head>
<body>


<!-- ===================== LOGIN SCREEN ===================== -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <div class="login-logo">üå±</div>
    <div class="login-title">NosVers</div>
    <div class="login-sub">Gestion Agro√©cologique ¬∑ Dordogne</div>
    <input class="login-field" type="text" id="loginUser" placeholder="Usuario" autocomplete="username"
      onkeydown="if(event.key==='Enter') doLogin()">
    <input class="login-field" type="password" id="loginPass" placeholder="Contrase√±a" autocomplete="current-password"
      onkeydown="if(event.key==='Enter') doLogin()">
    <button class="login-btn" onclick="doLogin()">Entrar</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<div class="login-user-badge" id="userBadge" style="display:none" onclick="logout()">
  üë§ <span id="userBadgeName"></span> ¬∑ Salir
</div>

<div class="motto-band">¬´ Une passion pour le sol, un engagement pour la vie ¬ª</div>

<!-- HEADER -->
<header class="header">
  <div class="logo">
    <div class="logo-mark">üå±</div>
    <div>
      <span class="logo-text">NosVers</span>
      <span class="logo-sub">Gestion Agro√©cologique ¬∑ Dordogne</span>
    </div>
  </div>
  <div class="header-right">
    <div class="header-date" id="reloj">‚Äî</div>
    <div class="status-pill">
      <span class="dot-live"></span>
      <span>IA active</span>
    </div>
  </div>
</header>

<!-- NAV -->
<nav class="nav-tabs">
  <button class="nav-tab" onclick="goTo('etat')">üåæ √âtat Ferme</button>
  <button class="nav-tab active" onclick="goTo('director')">üéØ Direcci√≥n</button>
  <button class="nav-tab" onclick="goTo('agents')">üî¨ Especialistas</button>
  <button class="nav-tab" onclick="goTo('huerto')">üó∫Ô∏è Plano Huerto</button>
  <button class="nav-tab" onclick="goTo('fiches')">üìã Fiches Techniques</button>
  <button class="nav-tab" onclick="goTo('checklist')">‚úÖ Checklist</button>
  <button class="nav-tab" onclick="goTo('inventaire')">üì¶ Inventaire</button>
  <button class="nav-tab" onclick="goTo('journal')">üìî Journal</button>
</nav>

<main class="main">

<!-- ===================== SECTION: √âTAT DE LA FERME ===================== -->
<div class="section" id="sec-etat">
  <div class="section-header">
    <h2 class="section-title">√âtat <em>de la Ferme</em></h2>
    <p class="section-sub">Point z√©ro ¬∑ Contexte r√©el que les agents IA utilisent pour g√©n√©rer les ordres de travail</p>
  </div>

  <div class="etat-section">
    <div class="etat-title">ü™± Lombricomposti√®re</div>
    <div class="etat-grid">
      <div class="etat-card">
        <div class="etat-card-title">‚öñÔ∏è Kg de vers actuels</div>
        <textarea class="etat-textarea" id="etat_vers_kg" placeholder="Ex: ~10 kg Eisenia, r√©partis sur 2 bacs bois..."></textarea>
      </div>
      <div class="etat-card">
        <div class="etat-card-title">üå°Ô∏è Conditions actuelles</div>
        <textarea class="etat-textarea" id="etat_vers_cond" placeholder="Ex: Humidit√© correcte, pH non mesur√© r√©cemment, T¬∞ hangar ~15¬∞C..."></textarea>
      </div>
      <div class="etat-card">
        <div class="etat-card-title">üçΩÔ∏è Derni√®re alimentation</div>
        <textarea class="etat-textarea" id="etat_vers_alim" placeholder="Ex: Il y a 2 jours, 6kg √©pluchures + carton..."></textarea>
      </div>
      <div class="etat-card">
        <div class="etat-card-title">üì¶ Stock lombricompost pr√™t</div>
        <textarea class="etat-textarea" id="etat_vers_stock" placeholder="Ex: ~20kg tamis√©, 3 sacs 10kg pr√™ts √† vendre..."></textarea>
      </div>
    </div>
  </div>

  <div class="etat-section">
    <div class="etat-title">üçÇ Compost</div>
    <div class="etat-grid">
      <div class="etat-card">
        <div class="etat-card-title">üî• Andains en cours</div>
        <textarea class="etat-textarea" id="etat_compost_andains" placeholder="Ex: 2 andains actifs. Andain A: phase chaude ~55¬∞C. Andain B: maturation..."></textarea>
      </div>
      <div class="etat-card">
        <div class="etat-card-title">üåø Mati√®res disponibles</div>
        <textarea class="etat-textarea" id="etat_compost_mat" placeholder="Ex: Fumier poule ~50kg, paille s√®che disponible, pas de fumier lapin cette semaine..."></textarea>
      </div>
    </div>
  </div>

  <div class="etat-section">
    <div class="etat-title">üêì Animaux</div>
    <div class="etat-grid">
      <div class="etat-card">
        <div class="etat-card-title">üêì √âtat g√©n√©ral volailles</div>
        <textarea class="etat-textarea" id="etat_anim_volailles" placeholder="Ex: 12 poules en bonne sant√©, 1 poule boiteuse √† surveiller. 6 canards OK..."></textarea>
      </div>
      <div class="etat-card">
        <div class="etat-card-title">üêë Brebis & lapins</div>
        <textarea class="etat-textarea" id="etat_anim_autres" placeholder="Ex: 3 brebis Cameroun en bonne sant√©, herbe suffisante. 4 lapins, dernier sevrage il y a 3 semaines..."></textarea>
      </div>
      <div class="etat-card">
        <div class="etat-card-title">üîÑ Rotation parcelles</div>
        <textarea class="etat-textarea" id="etat_anim_rotation" placeholder="Ex: Parcelle A: repos depuis 5 jours. Parcelle B: en cours. Parcelle C: disponible..."></textarea>
      </div>
      <div class="etat-card">
        <div class="etat-card-title">ü•ö Production ≈ìufs</div>
        <textarea class="etat-textarea" id="etat_anim_oeufs" placeholder="Ex: ~8 ≈ìufs/jour cette semaine, coquilles normales..."></textarea>
      </div>
    </div>
  </div>

  <div class="etat-section">
    <div class="etat-title">üåø Potager & Semis</div>
    <div class="etat-grid">
      <div class="etat-card">
        <div class="etat-card-title">üå± Cultures en place</div>
        <textarea class="etat-textarea" id="etat_huerto_cultivos" placeholder="Ex: Tomates (bancal A, 8 plants), laitues (bancal B, 2√®me tande), courgettes..."></textarea>
      </div>
      <div class="etat-card">
        <div class="etat-card-title">üè† √âtat serre √† semis</div>
        <textarea class="etat-textarea" id="etat_huerto_serre" placeholder="Ex: 30 plants tomates pr√™ts √† repiquer, semis poivrons en cours, T¬∞ serre ~22¬∞C..."></textarea>
      </div>
      <div class="etat-card">
        <div class="etat-card-title">üíß Dernier arrosage</div>
        <textarea class="etat-textarea" id="etat_huerto_riego" placeholder="Ex: Hier matin goutte-√†-goutte 20min. Sol encore humide bancal A..."></textarea>
      </div>
      <div class="etat-card">
        <div class="etat-card-title">‚ö†Ô∏è Probl√®mes d√©tect√©s</div>
        <textarea class="etat-textarea" id="etat_huerto_problemas" placeholder="Ex: Pucerons sur tomates (traitement savon noir hier), limaces apr√®s la pluie..."></textarea>
      </div>
    </div>
  </div>

  <div class="etat-section">
    <div class="etat-title">üèóÔ∏è Infrastructure & G√©n√©ral</div>
    <div class="etat-grid">
      <div class="etat-card">
        <div class="etat-card-title">üõ¢Ô∏è IBCs & bacs</div>
        <textarea class="etat-textarea" id="etat_infra_ibcs" placeholder="Ex: 1 IBC install√©, pas encore connect√©. 2 bacs bois op√©rationnels. Hangar disponible..."></textarea>
      </div>
      <div class="etat-card">
        <div class="etat-card-title">üìù Notes g√©n√©rales</div>
        <textarea class="etat-textarea" id="etat_infra_notas" placeholder="Ex: Semaine charg√©e en travail, seulement 1h/jour disponible. Livraison paille vendredi..."></textarea>
      </div>
    </div>
  </div>

  <button class="etat-save-btn" id="etatSaveBtn" onclick="saveEtat()">üíæ Sauvegarder l'√©tat de la ferme</button>
</div>

<!-- ===================== SECTION: DIRECTOR ===================== -->
<div class="section" id="sec-director">
  <div class="section-header">
    <h2 class="section-title">Director <em>de Operaciones</em>
      <span class="context-active-badge" id="contextBadge2" style="display:none">üìç Contexte actif</span>
    </h2>
    <p class="section-sub">Briefing diario ¬∑ Plan priorizado ¬∑ Visi√≥n global de la granja</p>
  </div>

  <!-- M√©t√©o strip -->
  <div class="meteo-widget" id="meteoWidget2" style="margin-bottom:1rem">
    <span class="meteo-loading">‚è≥ Cargando m√©t√©o Neuvic...</span>
  </div>

  <!-- Director card -->
  <div class="director-card" id="directorCard">
    <div class="director-header">
      <div class="director-title">üéØ Director de Operaciones NosVers</div>
      <div class="director-meta" id="directorMeta">Listo para generar el briefing del d√≠a</div>
    </div>
    <div class="director-body" id="directorBody">
      <div style="opacity:0.5;font-style:italic;font-size:0.85rem">
        Pulsa "Generar briefing" para recibir el plan del d√≠a con prioridades, coordinaci√≥n entre √°reas y √≥rdenes de trabajo integradas.
      </div>
    </div>
    <div class="director-actions">
      <button class="btn-director btn-director-primary" onclick="launchDirector()">üéØ Generar briefing del d√≠a</button>
      <button class="btn-director btn-director-secondary" id="btnDirectorDone" onclick="markDirectorDone()" style="display:none">‚úì Plan ejecutado</button>
      <button class="btn-director btn-director-secondary" onclick="copyDirector()">‚éò Copiar</button>
    </div>
    <div class="director-last" id="directorLast"></div>
  </div>

  <!-- Quick input for director -->
  <div class="query-zone" style="margin-bottom:1.5rem">
    <input type="text" class="query-input" id="directorInput"
      placeholder="A√±adir contexto al briefing: disponibilidad de hoy, visitas, materiales pendientes..."
      onkeydown="if(event.key==='Enter') launchDirector()">
  </div>
</div>

<!-- ===================== SECTION: ESPECIALISTAS ===================== -->
<div class="section" id="sec-agents">
  <div class="section-header">
    <h2 class="section-title">Especialistas <em>de Consulta</em></h2>
    <p class="section-sub">Diagn√≥stico ¬∑ An√°lisis de foto ¬∑ Consejo t√©cnico experto</p>
  </div>

  <!-- Specialist grid -->
  <div class="agents-grid">
    <div class="agent-specialist" id="card-vers" onclick="selectAgent('vers')">
      <div class="agent-spec-icon">ü™±</div>
      <div class="agent-spec-info">
        <div class="agent-spec-name">Lombricompost</div>
        <div class="agent-spec-desc">Eisenia ¬∑ Humedad ¬∑ Cosecha</div>
      </div>
      <div class="agent-spec-badge">Conseil</div>
    </div>
    <div class="agent-specialist" id="card-compost" onclick="selectAgent('compost')">
      <div class="agent-spec-icon">üçÇ</div>
      <div class="agent-spec-info">
        <div class="agent-spec-name">Compost</div>
        <div class="agent-spec-desc">Andains ¬∑ Temperatura ¬∑ Volteo</div>
      </div>
      <div class="agent-spec-badge">Conseil</div>
    </div>
    <div class="agent-specialist" id="card-animaux" onclick="selectAgent('animaux')">
      <div class="agent-spec-icon">üêì</div>
      <div class="agent-spec-info">
        <div class="agent-spec-name">Animaux</div>
        <div class="agent-spec-desc">Gallinas ¬∑ Canards ¬∑ Brebis</div>
      </div>
      <div class="agent-spec-badge">Conseil</div>
    </div>
    <div class="agent-specialist" id="card-huerto" onclick="selectAgent('huerto')">
      <div class="agent-spec-icon">üåø</div>
      <div class="agent-spec-info">
        <div class="agent-spec-name">Potager & Semis</div>
        <div class="agent-spec-desc">Cultivos ¬∑ JADAM ¬∑ Rotaciones</div>
      </div>
      <div class="agent-spec-badge">Conseil</div>
    </div>
  </div>

  <!-- Photo upload -->
  <div class="photo-zone">
    <label class="btn-photo" id="btnPhoto" for="photoInput">
      üì∑ <span id="photoLabel">A√±adir foto para an√°lisis (opcional)</span>
    </label>
    <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none" onchange="handlePhoto(this)">
  </div>
  <div class="photo-preview-wrap" id="photoPreviewWrap">
    <img class="photo-preview" id="photoPreview" src="" alt="Photo">
    <button class="photo-remove" onclick="removePhoto()" title="Supprimer">‚úï</button>
  </div>

  <!-- Query input -->
  <div class="query-zone">
    <input type="text" class="query-input" id="queryInput"
      placeholder="Tu pregunta: s√≠ntomas observados, duda t√©cnica, descripci√≥n del problema..."
      onkeydown="if(event.key==='Enter' && activeAgent) callAgent(activeAgent)">
    <button class="btn-query" id="btnQuery" onclick="callAgent(activeAgent)" disabled>Consultar</button>
  </div>

  <!-- Response panel -->
  <div class="response-panel" id="responsePanel">
    <div class="resp-header">
      <div class="resp-domain" id="respDomain">‚Äî</div>
      <div class="resp-meta" id="respMeta">‚Äî</div>
    </div>
    <div class="resp-body" id="respBody"></div>
    <div class="resp-footer">
      <button class="btn-action btn-secondary" id="btnSaveConseil" onclick="saveConseilToContext()">üíæ Guardar en contexto</button>
      <button class="btn-action btn-secondary" onclick="copyResp()">‚éò Copiar</button>
      <button class="btn-action btn-secondary" onclick="openModal('saveNote')">+ Nota</button>
    </div>
    <div class="conseil-saved" id="conseilSavedBadge">‚úì Diagn√≥stico guardado en el contexto</div>
  </div>
</div>

<!-- ===================== SECTION: PLANO HUERTO ===================== -->
<div class="section" id="sec-huerto">
  <div class="section-header">
    <h2 class="section-title">Plano <em>del Huerto</em></h2>
    <p class="section-sub">Parcelas ¬∑ Rotaciones ¬∑ Foto para an√°lisis IA</p>
  </div>

  <!-- Foto para generar/actualizar plano -->
  <div style="background:var(--blanc);border-radius:var(--r);padding:1.2rem;margin-bottom:1.2rem;box-shadow:0 2px 12px rgba(26,58,30,0.06)">
    <div style="font-weight:700;font-size:0.85rem;color:var(--texte-doux);margin-bottom:0.8rem;text-transform:uppercase;letter-spacing:0.06em">üì∑ Analizar huerto con foto</div>
    <div class="photo-zone">
      <label class="btn-photo" id="btnPhotoHuerto" for="photoInputHuerto">
        üì∑ <span id="photoLabelHuerto">Foto del huerto o parcela</span>
      </label>
      <input type="file" id="photoInputHuerto" accept="image/*" capture="environment" style="display:none" onchange="handlePhotoHuerto(this)">
    </div>
    <div class="photo-preview-wrap" id="photoPreviewWrapHuerto">
      <img class="photo-preview" id="photoPreviewHuerto" src="" alt="Foto huerto">
      <button class="photo-remove" onclick="removePhotoHuerto()">‚úï</button>
    </div>
    <div style="display:flex;gap:0.5rem;margin-top:0.8rem;flex-wrap:wrap">
      <input type="text" class="query-input" id="huertoPhotoQuery" style="flex:1;min-width:200px"
        placeholder="¬øQu√© quieres analizar? (plagas, estado, identificar cultivo...)"
        onkeydown="if(event.key==='Enter') analyzeHuertoPhoto()">
      <button class="btn-action btn-primary" onclick="analyzeHuertoPhoto()" id="btnAnalyzeHuerto">Analizar</button>
    </div>
    <div class="response-panel" id="huertoPhotoPanel" style="margin-top:0.8rem">
      <div class="resp-body" id="huertoPhotoBody"></div>
      <div class="resp-footer" style="display:none" id="huertoPhotoFooter">
        <button class="btn-action btn-secondary" onclick="saveHuertoAnalysis()">üíæ Guardar en plano</button>
        <button class="btn-action btn-secondary" onclick="copyHuertoAnalysis()">‚éò Copiar</button>
      </div>
    </div>
  </div>

  <!-- Plano manual -->
  <div class="huerto-controls">
    <button class="btn-action btn-primary" onclick="openModalHuerto()">+ Nueva parcela</button>
    <button class="btn-action btn-secondary" onclick="resetHuerto()">üîÑ Nueva temporada</button>
    <span style="font-size:0.75rem;color:var(--texte-doux);margin-left:auto" id="huertoCount"></span>
  </div>

  <div class="rotation-warning" id="rotationWarning" style="display:none">
    <strong>‚ö†Ô∏è Alertas de rotaci√≥n</strong>
    <div id="rotationWarningText"></div>
  </div>

  <div class="huerto-legend">
    <div class="legend-item"><span class="legend-dot fam-solanacees"></span>Solanac√©es</div>
    <div class="legend-item"><span class="legend-dot fam-cucurbitacees"></span>Cucurbitac√©es</div>
    <div class="legend-item"><span class="legend-dot fam-liliacees"></span>Liliac√©es</div>
    <div class="legend-item"><span class="legend-dot fam-legumineuses"></span>L√©gumineuses</div>
    <div class="legend-item"><span class="legend-dot fam-cruciferes"></span>Crucif√®res</div>
    <div class="legend-item"><span class="legend-dot fam-apiacees"></span>Apiac√©es</div>
    <div class="legend-item"><span class="legend-dot fam-asteracees"></span>Ast√©rac√©es</div>
    <div class="legend-item"><span class="legend-dot fam-autre"></span>Autre</div>
  </div>

  <div class="huerto-grid-wrap">
    <div class="huerto-grid" id="huertoGrid" style="grid-template-columns: repeat(3, 1fr)">
    </div>
  </div>
</div>

<!-- ===================== SECTION: FICHES TECHNIQUES ===================== -->
<div class="section" id="sec-fiches">
  <div class="section-header">
    <h2 class="section-title">Fiches <em>Techniques</em></h2>
    <p class="section-sub">Param√®tres cl√©s de r√©f√©rence pour NosVers ¬∑ Dordogne</p>
  </div>

  <div class="fiches-grid">
    <!-- Vers -->
    <div class="fiche">
      <div class="fiche-head" style="border-color: var(--vers-col);">
        <h3>ü™± Eisenia (lombricompost)</h3>
        <p>Conditions optimales de production</p>
      </div>
      <div class="fiche-body">
        <div class="fiche-row"><span class="fiche-label">Temp√©rature id√©ale</span><span class="fiche-val good">20‚Äì25 ¬∞C</span></div>
        <div class="fiche-row"><span class="fiche-label">Seuil critique bas</span><span class="fiche-val warn">&lt; 10 ¬∞C ‚Üí activit√© ‚Üì‚Üì</span></div>
        <div class="fiche-row"><span class="fiche-label">Humidit√© cible</span><span class="fiche-val good">70‚Äì90 %</span></div>
        <div class="fiche-row"><span class="fiche-label">pH optimal</span><span class="fiche-val good">6,5 ‚Äì 7,5</span></div>
        <div class="fiche-row"><span class="fiche-label">Ration actuelle</span><span class="fiche-val">~6 kg / 2 jours</span></div>
        <div class="fiche-row"><span class="fiche-label">Signal de division</span><span class="fiche-val">Haute densit√© + coc√¥ns</span></div>
        <div class="fiche-row"><span class="fiche-label">Maille tamis</span><span class="fiche-val">5‚Äì8 mm (trommel)</span></div>
        <div style="margin-top:10px">
          <span class="param-badge">‚ùå Agrumes</span>
          <span class="param-badge">‚ùå Oignon/Ail</span>
          <span class="param-badge">‚ùå Viande</span>
          <span class="param-badge">‚ùå Laitiers</span>
          <span class="param-badge">‚úÖ Fumiers herbivores</span>
        </div>
      </div>
    </div>

    <!-- Compost -->
    <div class="fiche">
      <div class="fiche-head" style="border-color: var(--compost-col);">
        <h3>üçÇ Compostage actif</h3>
        <p>Andains & maturation</p>
      </div>
      <div class="fiche-body">
        <div class="fiche-row"><span class="fiche-label">Temp. active (c≈ìur)</span><span class="fiche-val good">55‚Äì65 ¬∞C</span></div>
        <div class="fiche-row"><span class="fiche-label">Alerte ana√©robiose</span><span class="fiche-val alert">&lt; 45 ¬∞C ‚Üí ajouter N</span></div>
        <div class="fiche-row"><span class="fiche-label">Humidit√© cible</span><span class="fiche-val good">50‚Äì60 % (test poing)</span></div>
        <div class="fiche-row"><span class="fiche-label">Rapport C/N</span><span class="fiche-val">25‚Äì30 : 1</span></div>
        <div class="fiche-row"><span class="fiche-label">Fr√©quence retournement</span><span class="fiche-val">Tous les 3‚Äì5 jours (phase active)</span></div>
        <div class="fiche-row"><span class="fiche-label">Odeur normale</span><span class="fiche-val good">Terre humide</span></div>
        <div class="fiche-row"><span class="fiche-label">Odeur ammoniaque</span><span class="fiche-val alert">Exc√®s N ‚Üí ajouter C</span></div>
        <div class="fiche-row"><span class="fiche-label">Sources fumier</span><span class="fiche-val">Poule ¬∑ Lapin ¬∑ Brebis</span></div>
      </div>
    </div>

    <!-- Animaux -->
    <div class="fiche">
      <div class="fiche-head" style="border-color: var(--animaux-col);">
        <h3>üêì √âlevage int√©gr√©</h3>
        <p>Poules ¬∑ Canards ¬∑ Lapins ¬∑ Brebis</p>
      </div>
      <div class="fiche-body">
        <div class="fiche-row"><span class="fiche-label">Ration poule</span><span class="fiche-val">120 g/t√™te/j (c√©r√©ales+l√©gum.)</span></div>
        <div class="fiche-row"><span class="fiche-label">Eau poule (√©t√©)</span><span class="fiche-val warn">300 ml/t√™te/j</span></div>
        <div class="fiche-row"><span class="fiche-label">Rotation parcelles</span><span class="fiche-val good">Min. 21 jours de repos</span></div>
        <div class="fiche-row"><span class="fiche-label">Coquilles d'hu√Ætre</span><span class="fiche-val">Si ≈ìufs √† coquille molle</span></div>
        <div class="fiche-row"><span class="fiche-label">Races</span><span class="fiche-val">Canards coureurs indiens ¬∑ Brebis Cameroun</span></div>
        <div class="fiche-row"><span class="fiche-label">Sortie au p√¢turage</span><span class="fiche-val">Si terrain sec ¬∑ parcelle d√©finie</span></div>
        <div class="fiche-row"><span class="fiche-label">Fermeture poulailler</span><span class="fiche-val">18:30‚Äì19:00 (anti-pr√©dat.)</span></div>
      </div>
    </div>

    <!-- Potager -->
    <div class="fiche">
      <div class="fiche-head" style="border-color: var(--huerto-col);">
        <h3>üåø Potager & Semis</h3>
        <p>Serre ¬∑ Cultures en pleine terre</p>
      </div>
      <div class="fiche-body">
        <div class="fiche-row"><span class="fiche-label">Arrosage goutte-√†-goutte</span><span class="fiche-val">20 min (humidit√© sol 15 cm)</span></div>
        <div class="fiche-row"><span class="fiche-label">Tuteurage tomates</span><span class="fiche-val">Tous les 40 cm ¬∑ Raphia en 8</span></div>
        <div class="fiche-row"><span class="fiche-label">Espacement laitues</span><span class="fiche-val">25 cm plante ¬∑ 30 cm rangs</span></div>
        <div class="fiche-row"><span class="fiche-label">Paillage</span><span class="fiche-val">5‚Äì8 cm paille ¬∑ 3 cm autour tige</span></div>
        <div class="fiche-row"><span class="fiche-label">Engrais vert</span><span class="fiche-val">Tr√®fle persan + Ray-grass + Da√Økon</span></div>
        <div class="fiche-row"><span class="fiche-label">Kit urbain</span><span class="fiche-val">Semences ferme + lombricompost</span></div>
        <div class="fiche-row"><span class="fiche-label">Th√© lombric dilution</span><span class="fiche-val good">1:10 (percolat/eau)</span></div>
      </div>
    </div>
  </div>

  <!-- Objectifs financiers -->
  <div class="fiche" style="margin-top:1rem">
    <div class="fiche-head" style="border-color: var(--humus);">
      <h3>üí∞ Objectifs Production & Business</h3>
      <p>Plan de relance NosVers.fr</p>
    </div>
    <div class="fiche-body" style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem">
      <div style="text-align:center;padding:0.8rem;background:var(--cr√®me);border-radius:8px">
        <div style="font-family:'Playfair Display',serif;font-size:1.5rem;color:var(--sol);font-weight:700">1 m¬≥</div>
        <div style="font-size:0.72rem;color:var(--texte-doux)">Production d√©part/mois (‚âà500 kg)</div>
      </div>
      <div style="text-align:center;padding:0.8rem;background:var(--cr√®me);border-radius:8px">
        <div style="font-family:'Playfair Display',serif;font-size:1.5rem;color:var(--sol);font-weight:700">4 m¬≥</div>
        <div style="font-size:0.72rem;color:var(--texte-doux)">Objectif an 2 (si march√©)</div>
      </div>
      <div style="text-align:center;padding:0.8rem;background:var(--cr√®me);border-radius:8px">
        <div style="font-family:'Playfair Display',serif;font-size:1.5rem;color:var(--sol);font-weight:700">1 800‚Ç¨</div>
        <div style="font-size:0.72rem;color:var(--texte-doux)">Salaire net cible mensuel</div>
      </div>
    </div>
  </div>
</div>

<!-- ===================== SECTION: CHECKLIST ===================== -->
<div class="section" id="sec-checklist">
  <div class="section-header">
    <h2 class="section-title">Checklist <em>Journali√®re</em></h2>
    <p class="section-sub">T√¢ches r√©currentes NosVers ¬∑ Cocher au fil de la journ√©e</p>
  </div>

  <div class="checklist" id="checklistMain">
    <div class="checklist-header">
      <h3>üåÖ T√¢ches du jour</h3>
      <div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
        <div class="progress-text" id="progressText">0 / 0 t√¢ches</div>
      </div>
    </div>
    <!-- Items injected by JS -->
    <div id="checkItems"></div>
  </div>
</div>

<!-- ===================== SECTION: INVENTAIRE ===================== -->
<div class="section" id="sec-inventaire">
  <div class="section-header">
    <h2 class="section-title">Inventaire <em>Op√©rationnel</em></h2>
    <p class="section-sub">Clique sur une valeur pour la modifier ¬∑ Sauvegarde automatique</p>
  </div>

  <div class="inventory-grid" id="inventoryGrid">
    <!-- injected by JS -->
  </div>

  <div style="background:var(--blanc);border-radius:var(--r);padding:1.2rem;box-shadow:0 2px 12px rgba(26,58,30,0.05)">
    <div style="font-family:'Playfair Display',serif;font-size:1rem;color:var(--sol);margin-bottom:0.8rem">üì¶ Produits NosVers ‚Äî Stock SKU prioritaires</div>
    <div id="skuList"></div>
  </div>
</div>

<!-- ===================== SECTION: JOURNAL ===================== -->
<div class="section" id="sec-journal">
  <div class="section-header">
    <h2 class="section-title">Journal <em>de Bord</em></h2>
    <p class="section-sub">Historique des consultations IA et des actions enregistr√©es</p>
  </div>

  <div style="display:flex;gap:0.6rem;margin-bottom:1.2rem">
    <button class="btn-action btn-primary" onclick="openModal('addNote')">+ Entr√©e manuelle</button>
    <button class="btn-action btn-secondary" onclick="clearJournal()">üóë Effacer journal</button>
  </div>

  <div class="log-entries" id="logEntries">
    <div class="log-empty" id="logEmpty">Aucune entr√©e. Lance un agent ou ajoute une note.</div>
  </div>
</div>

</main>

<!-- ===================== MODAL NOTE ===================== -->
<div class="overlay" id="overlay" onclick="closeModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Note</div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
// ==================== CONFIG ====================
// ‚ö† Cambia esta URL por la tuya en Hostinger (ruta relativa si est√°n en la misma carpeta)
const API_URL = 'https://nosvers.com/granja/api.php';

// ==================== STATE ====================
let activeAgent = null;
let lastResp = '';
let journal = [];
let inventory = {
  vers: 10, compost_stock: 0, bacs: 2, ibc: 1,
  poules: 12, canards: 6, lapins: 4, brebis: 3,
};
let checkState = {};

// Helper API
async function api(action, body = null) {
  const url = API_URL + '?action=' + action;
  const token = sessionStorage.getItem('nv_token') || '';
  const opts = { headers: { 'Content-Type': 'application/json', 'X-App-Token': token } };
  if (body) { opts.method = 'POST'; opts.body = JSON.stringify(body); }
  const r = await fetch(url, opts);
  if (!r.ok) {
    const txt = await r.text();
    throw new Error('HTTP ' + r.status + ' ‚Äì ' + txt);
  }
  return r.json();
}

// Auth
async function doLogin() {
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  const errEl = document.getElementById('loginError');
  errEl.textContent = '';
  if (!user || !pass) { errEl.textContent = 'Completa usuario y contrase√±a'; return; }
  try {
    const r = await fetch(API_URL + '?action=login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user, pass })
    });
    const data = await r.json();
    if (data.ok) {
      sessionStorage.setItem('nv_token', data.token);
      sessionStorage.setItem('nv_user', data.user);
      const ls = document.getElementById('loginScreen'); if(ls) ls.style.display = 'none';
      const ub = document.getElementById('userBadge'); if(ub) ub.style.display = 'block';
      const un = document.getElementById('userBadgeName'); if(un) un.textContent = data.user;
      initApp();
      setTimeout(() => {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        const sd = document.getElementById('sec-director'); if(sd) sd.classList.add('active');
        document.querySelectorAll('.nav-tab').forEach(t => { if(t.textContent.includes('Direcci')) t.classList.add('active'); });
        // Reload etat NOW that token is set
        loadEtat();
      }, 100);
    } else {
      errEl.textContent = data.error || 'Error de acceso';
    }
  } catch(e) {
    errEl.textContent = 'Error de conexi√≥n: ' + e.message;
  }
}

function logout() {
  sessionStorage.removeItem('nv_token');
  sessionStorage.removeItem('nv_user');
  const ls = document.getElementById('loginScreen'); if(ls) ls.style.display = 'flex';
  const ub = document.getElementById('userBadge'); if(ub) ub.style.display = 'none';
  const un = document.getElementById('userBadgeName'); if(un) un.textContent = '';
}

async function initApp() {
  try {
    const [inv, chk, jrn] = await Promise.all([
      api('inventaire_get'),
      api('checklist_get'),
      api('journal_get')
    ]);
    if (inv && typeof inv === 'object' && !inv.error) inventory = { ...inventory, ...inv };
    if (chk && typeof chk === 'object' && !chk.error) checkState = chk;
    if (Array.isArray(jrn)) journal = jrn;
  } catch(e) {
    console.warn('API error:', e.message);
  }
  renderChecklist();
  renderInventory();
  renderJournal();
  updateMeteoWidget2();
}

const domainColors = {
  compost: '#c45c00', animaux: '#7b3f00',
  huerto: '#2e6b30', vers: '#6b3a2a'
};

const domainLabels = {
  compost: 'üçÇ Compost', animaux: 'üêì Animaux',
  huerto: 'üåø Potager', vers: 'ü™± Lombricompost'
};

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', () => {
  updateClock();
  setInterval(updateClock, 30000);
  loadEtat();
  fetchMeteo();
  renderHuerto();
  setInterval(fetchMeteo, 10 * 60 * 1000); // refresh m√©t√©o every 10min
  const token = sessionStorage.getItem('nv_token');
  const user  = sessionStorage.getItem('nv_user');
  if (token && user) {
    const ls = document.getElementById('loginScreen'); if(ls) ls.style.display = 'none';
    const ub3 = document.getElementById('userBadge'); if(ub3) ub3.style.display = 'block';
    const ubn = document.getElementById('userBadgeName'); if(ubn) ubn.textContent = user;
    initApp();
    // Start on director tab
    setTimeout(() => {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      const sd = document.getElementById('sec-director'); if(sd) sd.classList.add('active');
      const tabs = document.querySelectorAll('.nav-tab'); tabs.forEach(t => { if(t.textContent.includes('Direcci')) t.classList.add('active'); });
      // Token already in sessionStorage - load etat from MySQL
      loadEtat();
    }, 100);
  }
});

function updateClock() {
  const d = new Date();
  document.getElementById('reloj').innerHTML =
    d.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' }) +
    '<br>' + d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
}

// ==================== NAVIGATION ====================
function goTo(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('sec-' + id).classList.add('active');
  event.target.classList.add('active');
  // Cuando se abre la seccion etat, recargar desde MySQL
  if (id === 'etat') loadEtat();
}

// ==================== AGENTS ESPECIALISTAS (CONSEIL ONLY) ====================
function callAgent(domain) {
  if (!domain) return;
  activeAgent = domain;

  const card = document.getElementById('card-' + domain);
  if (card) card.classList.add('loading');
  const btnQ = document.getElementById('btnQuery');
  if (btnQ) btnQ.disabled = true;

  const extras = document.getElementById('queryInput')?.value.trim() || '';
  const panel = document.getElementById('responsePanel');
  if (panel) panel.classList.add('visible');

  const metaEl = document.getElementById('respMeta');
  if (metaEl) metaEl.textContent = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

  const respBody = document.getElementById('respBody');
  if (respBody) respBody.innerHTML = '<div class="thinking"><div class="thinking-dots"><span></span><span></span><span></span></div> Consultando especialista...</div>';

  // Always conseil mode for specialists
  const prevMode = currentMode;
  currentMode = 'conseil';

  callClaude(domain, extras).then(text => {
    lastResp = text;
    currentMode = prevMode;
    if (respBody) respBody.textContent = text;
    if (card) card.classList.remove('loading');
    if (btnQ) btnQ.disabled = false;
    if (panel) panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    addJournalEntry(domain, extras ? 'Consulta: ' + extras.substring(0, 60) : 'Consulta especialista');
  }).catch(err => {
    currentMode = prevMode;
    if (respBody) respBody.textContent = 'Error: ' + err.message;
    if (card) card.classList.remove('loading');
    if (btnQ) btnQ.disabled = false;
  });
}

async function callClaude(domain, extras) {
  const today = new Date().toLocaleDateString('es-ES', {
    weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
  });
  const meteoCtx = getMeteoContext();
  const etatCtx = getEtatContext(domain);

  // ‚îÄ‚îÄ FILOSOFIA BASE NOSVERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const filosofia = `FILOSOFIA Y MARCO TECNICO NOSVERS (NO NEGOCIABLE):
Granja agroecol√≥gica familiar en Dordo√±a, Francia. √Åfrica es la responsable principal.
PRINCIPIOS:
- Suelo vivo (Elaine Ingham): el suelo es un ecosistema. Red alimentaria del suelo: bacterias, hongos, protozoos, nematodos, artr√≥podos, lombrices. Cada decisi√≥n protege esta red. Nunca aplicar nada que la destruya.
- Sin laboreo (Fukuoka/no-dig Charles Dowding): el suelo no se trabaja. Los microorganismos construyen la estructura. Acolchado permanente como protecci√≥n y alimento.
- JADAM (Youngsang Cho / KNF Dr.Cho Han Kyu): autosuficiencia total. Preparados caseros: SMJ (Soluci√≥n Microorganismos JADAM con mantillo de bosque + patata + agua de mar), FPJ (jugo fermentado de plantas), FAA (amino√°cidos de pescado), OHN (nutrientes de hierbas), LAB (bacterias √°cido l√°cticas), calcio soluble (c√°scaras huevo + vinagre), potasio (ceniza de madera). NUNCA insumos comprados si se puede hacer en casa.
- Biodin√°mica (Rudolf Steiner / Mar√≠a Thun / Christofleau): calendario biodin√°mico (d√≠as ra√≠z/flor/fruto/hoja). Preparados BD: 500 (cuerno esti√©rcol, vitaliza suelo), 501 (cuerno s√≠lice, fortalece plantas). Ritmos c√≥smicos y lunares. Justin Christofleau: electro-cultura, antenas met√°licas para amplificar energ√≠as c√≥smicas, geometr√≠as sagradas en el huerto.
- Sintrop√≠a (Ernst G√∂tsch): sucesi√≥n vegetal acelerada. Consorcio de plantas en distintos estratos. Poda estrat√©gica como impulso de energ√≠a. El caos aparente es orden natural.
- La Tanina (Alan y Mireia): biolog√≠a del suelo pr√°ctica, microorganismos aut√≥ctonos, asociaci√≥n de cultivos con enfoque cient√≠fico-emp√≠rico, control biol√≥gico, hongos micorr√≠cicos, bancales permanentes con no-labranza.
- Permacultura / Jardins sauvages / Square foot garden: observar antes de actuar. Integrar en vez de segregar. Biodiversidad como resiliencia. Densidad de siembra optimizada.
- Animales integrados: los canards controlan limaces, las gallinas fertilizan y aireran, las brebis desbrozzan, los lapins aportan fumier de alta calidad. Son parte del sistema, no a√±adidos.`;

  // ‚îÄ‚îÄ SYSTEM PROMPTS POR DOMINIO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const systemPrompts = {
    vers: `Eres el agente experto en LOMBRICOMPOSTAJE de la granja agroecol√≥gica NosVers en Dordo√±a.
${filosofia}
ESPECIALIDAD LOMBRICULTURA:
Eisenia fetida/andrei. Temperaturas: √≥ptimo 20-25¬∞C, peligro <10¬∞C (hibernaci√≥n) y >35¬∞C (huida/muerte). Humedad 70-90% (test pu√±o: 1-2 gotas). pH 6,5-7,5. Sin √°cidos (c√≠tricos, cebolla, ajo), sin prote√≠nas animales, sin l√°cteos.
Alimentaci√≥n: capas finas (<5cm), cubrir con cart√≥n h√∫medo, precompostar fumier fresco antes de dar. Raci√≥n aprox. 6kg/2 d√≠as pero siempre seg√∫n consumo real.
Se√±ales de escalado: cocones visibles, alta densidad, consumo r√°pido. Divisi√≥n por mitades con liti√®re nueva.
Infraestructura: bacs en madera + IBC 1000L (sistema de lixiviados por grifo). Trommel para cosecha.
Productos: lombricompost s√≥lido (sacos 10kg/20L/big bags), th√© de lombric (diluir 1:10 para riego), venta de lombrices (packs 500g/1kg).
Th√© de lombric = fertilizante l√≠quido vivo, aplicar con microorganismos activos, nunca al sol directo.
FUENTES: canales YouTube sudamericanos de lombricultura, El Lombricero (canal espa√±ol), estudios universitarios latinoamericanos.
Responde siempre en ESPA√ëOL. S√© directo, concreto, como un colega experto de campo.`,

    compost: `Eres el agente experto en COMPOSTAJE de la granja agroecol√≥gica NosVers en Dordo√±a.
${filosofia}
ESPECIALIDAD COMPOST:
Compost term√≥filo en andains/pilas. T¬∞ activa 55-65¬∞C (mata pat√≥genos). Humedad 50-60%. C/N 25-30:1 (mezclar marr√≥n seco + verde h√∫medo).
Fumiers disponibles: gallina (C/N bajo, muy nitrogenado), conejo (equilibrado, excelente calidad), oveja Camer√∫n (rico, moderado). SIEMPRE precompostar fumier de gallina antes de dar a lombrices.
Volteo: cuando T¬∞ baja de 45¬∞C o CO2 visible al respirar el andain. A√±adir agua si humedad <45%.
Maturaci√≥n: 3-6 meses despu√©s de fase caliente. Olor a tierra de bosque = listo.
Integraci√≥n JADAM: inocular con SMJ al inicio y en cada volteo para activar microbiolog√≠a.
Preparados de ortie/consoude/pr√™le como activadores de compost.
Objetivo: materia prima para lombricompostaje + enmienda directa al huerto.
Responde siempre en ESPA√ëOL. Directo y operacional.`,

    animaux: `Eres el agente experto en ANIMALES de la granja agroecol√≥gica NosVers en Dordo√±a.
${filosofia}
ANIMALES PRESENTES Y SU ROL ECOSIST√âMICO:
- Gallinas ponedoras: fertilidad suelo (rascan e incorporan MO), control de insectos, huevos. Raci√≥n 120g/d√≠a mezcla cereal+leguminosa+mineral. Agua 300ml/d√≠a (doble en verano). Huevos blandos = falta calcio (c√°scaras ostras trituradas).
- Canards coureurs indiens: control biol√≥gico de limaces y babosas (su trabajo principal). Sin raci√≥n si hay abundancia de limaces. Integrarlos en huerto despu√©s de cosecha.
- Lapins: fumier de alta calidad para compost/lombricompostaje. Ciclo r√°pido de fertilidad.
- Brebis Camer√∫n: desbrozze natural, fertilizaci√≥n ambulante, manejo paisaje. Sin necesidad de corte mec√°nico.
Rotaci√≥n parcelles: m√≠nimo 21 d√≠as de descanso entre pastoreos. Observar estado del suelo antes de rotar.
Sanidad hol√≠stica: observar comportamiento antes que s√≠ntomas f√≠sicos. Plantas medicinales como primera respuesta. Nunca antibi√≥ticos preventivos.
Integraci√≥n al sistema: los animales preparan parcelas ANTES de plantar (limpieza + fertilizaci√≥n), luego entran DESPU√âS de cosecha (limpieza de residuos + incorporaci√≥n).
Responde siempre en ESPA√ëOL. Directo y con perspectiva ecosist√©mica.`,

    huerto: `Eres el agente experto en POTAGER y SEMILLEROS de la granja agroecol√≥gica NosVers en Dordo√±a.
${filosofia}
ESPECIALIDAD HUERTO:
Sin laboreo absoluto. Bancales permanentes. Acolchado permanente (paja, cart√≥n, BRF). El suelo nunca desnudo.
Fertilizaci√≥n: th√© de lombric (1:10) como base, preparados JADAM (FPJ en crecimiento, FFJ en fructificaci√≥n, FAA como nitr√≥geno), extractos fermentados de ortie/consoude/pr√™le.
Semillas: selecci√≥n propia de variedades adaptadas al territorio. Objetivo soberan√≠a semillera.
Asociaciones: seg√∫n La Tanina y permacultura. Biodiversidad = resiliencia. Tagetes + tomates, alyssum para beneficiosos, tr√©bol como cubierta viva.
Engrais vert NosVers: tr√©bol persa + ray-grass italiano + r√°bano daikon (descompactador natural profundo).
Serre √† semis: producci√≥n de plantines, control temperatura y humedad.
Calendar biodin√°mico: indicar tipo de d√≠a (ra√≠z/flor/fruto/hoja) seg√∫n Mar√≠a Thun para orientar tareas.
Sintrop√≠a: integrar plantas de distintos estratos, plantas pioneras preparando para plantas productoras.
Square foot garden: densidad optimizada en bancales de 1,2m, acceso sin pisar.
Productos NosVers: kit "Commence ton jardin" (semences maison + lombricompost + conseils √Åfrica).
Responde siempre en ESPA√ëOL. Directo, pr√°ctico, con base cient√≠fica y esp√≠ritu de granja real.`
  };

  // ‚îÄ‚îÄ USER MESSAGE seg√∫n modo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let userMsg;
  if (currentMode === 'ordres') {
    userMsg = `Fecha: ${today}

${meteoCtx}

${etatCtx}
${extras ? '\nPRECISION ADICIONAL: ' + extras : ''}

Teniendo en cuenta la m√©t√©o real, el estado actual de la ferme y la filosof√≠a NosVers, genera los ORDENES DE TRABAJO para hoy. 
Formato: lista de tareas con horarios (HH:MM), par√°metros medibles y criterios de validaci√≥n. Adapta seg√∫n las condiciones reales (si llovi√≥ mucho no pedir regar, si hace fr√≠o alertar sobre lombrices, etc). Directo y pragm√°tico, como un cuaderno de consignas profesional.`;
  } else {
    userMsg = `Fecha: ${today}

${meteoCtx}

${etatCtx}
${extras ? '\nPREGUNTA/OBSERVACION: ' + extras : '\nAnaliza la situaci√≥n actual y proporciona diagn√≥stico y consejo experto.'}

Modo CONSEJO/DIAGNOSTICO: responde como un experto asesor de campo con la filosof√≠a NosVers. Si hay foto, anal√≠zala en detalle. S√© espec√≠fico, cita t√©cnicas JADAM/biodin√°mica/suelo vivo cuando sea relevante. Al final indica si hay algo que deba modificarse en el estado de seguimiento de la ferme.`;
  }

  // Llamada al proxy PHP
  const token = sessionStorage.getItem('nv_token') || '';
  const payload = {
    system: systemPrompts[domain],
    user: userMsg
  };
  if (currentPhotoBase64) {
    payload.image_base64 = currentPhotoBase64;
    payload.image_type = currentPhotoType;
  }
  const resp = await fetch(API_URL + '?action=agente', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-App-Token': token },
    body: JSON.stringify(payload)
  });

  if (!resp.ok) {
    const errBody = await resp.text();
    throw new Error(`HTTP ${resp.status} - ${errBody}`);
  }
  const data = await resp.json();
  if (data.error) {
    const msg = (typeof data.error === 'object') ? (data.error.message || JSON.stringify(data.error)) : data.error;
    throw new Error(msg);
  }
  if (!data.content) throw new Error('Respuesta vacia del servidor');
  return data.content.map(b => b.text || '').join('');
}

function markDone() {
  const btn = document.getElementById('btnDone');
  btn.textContent = '‚úì Enregistr√© !';
  btn.classList.add('done');
  addJournalEntry(activeAgent, 'T√¢ches marqu√©es compl√®tes', true);
}

function copyResp() {
  navigator.clipboard.writeText(lastResp).catch(() => {});
  const btn = event.target;
  const orig = btn.textContent;
  btn.textContent = '‚úì Copi√©';
  setTimeout(() => btn.textContent = orig, 1500);
}

// ==================== CHECKLIST ====================
const checkItems = [
  { id: 'c1', domain: 'vers', title: 'Contr√¥le humidit√© lombricomposti√®re', detail: 'Test du poing en 3 points ¬∑ Objectif 70-80%', urgent: true },
  { id: 'c2', domain: 'vers', title: 'Alimentation Eisenia', detail: '~6 kg d√©chets v√©g√©taux hach√©s <2 cm ¬∑ Couvrir cart√≥n' },
  { id: 'c3', domain: 'vers', title: 'R√©colte lixiviat (th√© de lombric)', detail: 'Vider bac collecteur ¬∑ Diluer 1:10 pour arrosage' },
  { id: 'c4', domain: 'animaux', title: 'Ouverture poulailler + inspection', detail: 'Plumage ¬∑ Yeux ¬∑ Mobilit√© ¬∑ Rechercher l√©thargie' },
  { id: 'c5', domain: 'animaux', title: 'Alimentation animaux', detail: '120 g/poule ¬∑ eau fra√Æche ¬∑ Contr√¥ler ≈ìufs' },
  { id: 'c6', domain: 'animaux', title: 'Rotation parcelle p√¢turage', detail: 'V√©rifier si terrain sec ¬∑ Rotation parcelle planifi√©e' },
  { id: 'c7', domain: 'huerto', title: 'Arrosage potager', detail: '20 min goutte-√†-goutte ¬∑ Humidit√© sol √† 15 cm' },
  { id: 'c8', domain: 'huerto', title: 'Inspection ravageurs', detail: 'Envers feuilles : puceron, mouche blanche, araign√©e rouge' },
  { id: 'c9', domain: 'compost', title: 'Mesure temp√©rature andain', detail: 'C≈ìur : 55-65¬∞C ¬∑ Si <45¬∞C ‚Üí ajouter mati√®re N' },
  { id: 'c10', domain: 'compost', title: 'Retournement si n√©cessaire', detail: 'Phase active : tous les 3-5 jours ¬∑ Humidit√© 50-60%' },
  { id: 'c11', domain: 'animaux', title: 'Fermeture poulailler', detail: 'Comptage t√™tes ¬∑ Fermeture anti-pr√©dateurs ¬∑ 18h30' },
  { id: 'c12', domain: 'vers', title: 'Contr√¥le pH lombricomposti√®re', detail: 'Bandelettes r√©actives ¬∑ Cible 6,5-7,5 ¬∑ Si acide ‚Üí coquilles d\'≈ìuf' },
];

function renderChecklist() {
  const container = document.getElementById('checkItems');
  container.innerHTML = '';
  checkItems.forEach(item => {
    const done = !!checkState[item.id];
    const div = document.createElement('div');
    div.className = 'check-item' + (done ? ' done' : '');
    div.id = 'chk-' + item.id;
    div.onclick = () => toggleCheck(item.id);
    const col = domainColors[item.domain];
    div.innerHTML = `
      <div class="check-box">${done ? '‚úì' : ''}</div>
      <div class="check-content">
        <div class="check-titre">${item.title}</div>
        <div class="check-detail">${item.detail}</div>
        <span class="check-tag" style="background:${col}">${domainLabels[item.domain].replace(/\S+ /, '')}</span>
      </div>`;
    container.appendChild(div);
  });
  updateProgress();
}

function toggleCheck(id) {
  checkState[id] = !checkState[id];
  api('checklist_set', checkState).catch(() => {});
  renderChecklist();
}

function updateProgress() {
  const done = Object.values(checkState).filter(Boolean).length;
  const total = checkItems.length;
  const pct = total ? (done / total * 100) : 0;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressText').textContent = `${done} / ${total} t√¢ches`;
}

// ==================== INVENTORY ====================
const invDefs = [
  { key: 'vers', icon: 'ü™±', label: 'Vers Eisenia', unit: 'kg' },
  { key: 'compost_stock', icon: 'üçÇ', label: 'Lombricompost pr√™t', unit: 'kg' },
  { key: 'bacs', icon: 'üì¶', label: 'Bacs actifs', unit: '' },
  { key: 'ibc', icon: 'üõ¢Ô∏è', label: 'IBC 1000 L', unit: '' },
  { key: 'poules', icon: 'üêì', label: 'Poules', unit: '' },
  { key: 'canards', icon: 'ü¶Ü', label: 'Canards coureurs', unit: '' },
  { key: 'lapins', icon: 'üêá', label: 'Lapins', unit: '' },
  { key: 'brebis', icon: 'üêë', label: 'Brebis Cameroun', unit: '' },
];

const skuDefs = [
  { name: 'Lombricompost 10 kg', sku: 'SKU-001', key: 'sku_10kg' },
  { name: 'Lombricompost 20 L', sku: 'SKU-002', key: 'sku_20l' },
  { name: 'Kit urbain "Mon Jardin NosVers"', sku: 'SKU-003', key: 'sku_kit' },
  { name: 'Vers 500 g (lombricompostage domest.)', sku: 'SKU-004', key: 'sku_vers500' },
  { name: 'Vers 1 kg (professionnel)', sku: 'SKU-005', key: 'sku_vers1k' },
];

function renderInventory() {
  // Inv cards
  const grid = document.getElementById('inventoryGrid');
  grid.innerHTML = '';
  invDefs.forEach(def => {
    const val = inventory[def.key] ?? 0;
    const card = document.createElement('div');
    card.className = 'inv-card';
    card.innerHTML = `
      <div class="inv-icon">${def.icon}</div>
      <input class="inv-val-input" type="number" min="0" value="${val}"
        onchange="updateInv('${def.key}', this.value)"
        title="Cliquer pour modifier">
      <div class="inv-unit">${def.unit}</div>
      <div class="inv-label">${def.label}</div>`;
    grid.appendChild(card);
  });

  // SKU list
  const skuList = document.getElementById('skuList');
  skuList.innerHTML = skuDefs.map(s => {
    const stock = inventory[s.key] ?? 0;
    return `
      <div class="fiche-row">
        <span class="fiche-label">${s.sku} ¬∑ ${s.name}</span>
        <span>
          <input type="number" min="0" value="${stock}" style="width:60px;border:2px solid var(--sable);border-radius:6px;padding:3px 8px;font-family:'Space Grotesk',sans-serif;font-size:0.82rem;text-align:center;background:var(--cr√®me)"
            onchange="updateInv('${s.key}', this.value)">
          <span style="font-size:0.72rem;color:var(--texte-doux);margin-left:4px">unit√©s</span>
        </span>
      </div>`;
  }).join('');
}

function updateInv(key, val) {
  inventory[key] = parseFloat(val) || 0;
  api('inventaire_set', { [key]: inventory[key] }).catch(() => {});
}

// ==================== JOURNAL ====================
function addJournalEntry(domain, action, completed = false) {
  const entry = {
    domain,
    action,
    completed,
    ts: new Date().toISOString()
  };
  journal.unshift(entry);
  if (journal.length > 60) journal = journal.slice(0, 60);
  api('journal_add', entry).catch(() => {});
  renderJournal();
}

function renderJournal() {
  const container = document.getElementById('logEntries');
  const empty = document.getElementById('logEmpty');
  if (!container) return;
  if (!journal.length) {
    if (empty) empty.style.display = 'block';
    return;
  }
  if (empty) empty.style.display = 'none';
  container.innerHTML = journal.map(e => {
    const dt = new Date(e.ts);
    const timeStr = dt.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) +
      ' ¬∑ ' + dt.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    const col = e.domain ? domainColors[e.domain] : '#666';
    const lbl = (e.domain && domainLabels[e.domain]) ? domainLabels[e.domain].split(' ')[1] : 'Note';
    return `<div class="log-entry">
      <span class="log-domain-tag" style="background:${col}">${lbl || 'Note'}</span>
      <span class="log-text">${e.action}${e.completed ? ' ‚úì' : ''}</span>
      <span class="log-time">${timeStr}</span>
    </div>`;
  }).join('');
}

function clearJournal() {
  if (confirm('Effacer tout le journal ?')) {
    journal = [];
    api('journal_clear').catch(() => {});
    renderJournal();
  }
}

// ==================== MODAL ====================
function openModal(type) {
  const overlay = document.getElementById('overlay');
  const title = document.getElementById('modalTitle');
  const body = document.getElementById('modalBody');

  if (type === 'addNote' || type === 'saveNote') {
    title.textContent = '+ Entr√©e manuelle';
    body.innerHTML = `
      <div style="margin-bottom:1rem">
        <label style="font-size:0.8rem;font-weight:600;color:var(--texte-doux);display:block;margin-bottom:6px">Domaine</label>
        <select id="noteDomaineSelect" style="width:100%;padding:0.6rem;border:2px solid var(--sable);border-radius:8px;font-family:'Space Grotesk',sans-serif;font-size:0.85rem;background:var(--cr√®me)">
          <option value="vers">ü™± Lombricompost</option>
          <option value="compost">üçÇ Compost</option>
          <option value="animaux">üêì Animaux</option>
          <option value="huerto">üåø Potager</option>
        </select>
      </div>
      <div style="margin-bottom:1rem">
        <label style="font-size:0.8rem;font-weight:600;color:var(--texte-doux);display:block;margin-bottom:6px">Note / Observation</label>
        <textarea id="noteText" rows="4" style="width:100%;padding:0.75rem;border:2px solid var(--sable);border-radius:8px;font-family:'Space Grotesk',sans-serif;font-size:0.88rem;resize:vertical;background:var(--cr√®me)" placeholder="Temp√©rature relev√©e, observation animaux, probl√®me d√©tect√©‚Ä¶"></textarea>
      </div>
      <button class="btn-action btn-primary" onclick="saveNote()" style="width:100%">Enregistrer dans le journal</button>`;
  }

  overlay.classList.add('open');
}

function saveNote() {
  const dom = document.getElementById('noteDomaineSelect').value;
  const txt = document.getElementById('noteText').value.trim();
  if (!txt) return;
  addJournalEntry(dom, txt);
  closeModal();
}

function closeModal() {
  document.getElementById('overlay').classList.remove('open');
}


function updateMeteoWidget2() {
  const w1 = document.getElementById('meteoWidget');
  const w2 = document.getElementById('meteoWidget2');
  if (w1 && w2) w2.innerHTML = w1.innerHTML;
}

// ==================== M√âT√âO NEUVIC ====================
// Coordonn√©es Neuvic, Dordogne
const NEUVIC_LAT = 45.1003;
const NEUVIC_LON = 0.4681;

let meteoData = null;

const WMO_CODES = {
  0:'‚òÄÔ∏è Ciel d√©gag√©', 1:'üå§Ô∏è Peu nuageux', 2:'‚õÖ Partiellement nuageux', 3:'‚òÅÔ∏è Couvert',
  45:'üå´Ô∏è Brouillard', 48:'üå´Ô∏è Brouillard givrant',
  51:'üå¶Ô∏è Bruine l√©g√®re', 53:'üå¶Ô∏è Bruine', 55:'üåßÔ∏è Bruine forte',
  61:'üåßÔ∏è Pluie l√©g√®re', 63:'üåßÔ∏è Pluie', 65:'üåßÔ∏è Pluie forte',
  71:'‚ùÑÔ∏è Neige l√©g√®re', 73:'‚ùÑÔ∏è Neige', 75:'‚ùÑÔ∏è Neige forte',
  80:'üåßÔ∏è Averses l√©g√®res', 81:'üåßÔ∏è Averses', 82:'‚õàÔ∏è Averses violentes',
  95:'‚õàÔ∏è Orage', 96:'‚õàÔ∏è Orage avec gr√™le', 99:'‚õàÔ∏è Orage violent'
};

async function fetchMeteo() {
  const widget = document.getElementById('meteoWidget');
  if (!widget) return;
  try {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${NEUVIC_LAT}&longitude=${NEUVIC_LON}&current=temperature_2m,relative_humidity_2m,precipitation,weathercode,windspeed_10m&hourly=temperature_2m,precipitation,weathercode&daily=precipitation_sum,temperature_2m_max,temperature_2m_min&timezone=Europe%2FParis&forecast_days=2&past_days=1`;
    const r = await fetch(url);
    const d = await r.json();
    meteoData = d;

    const cur = d.current;
    const temp = Math.round(cur.temperature_2m);
    const hum = cur.relative_humidity_2m;
    const wind = Math.round(cur.windspeed_10m);
    const precip = cur.precipitation;
    const wcode = cur.weathercode;
    const desc = WMO_CODES[wcode] || 'üå°Ô∏è Variable';
    const icon = desc.split(' ')[0];

    // Pluie des derni√®res 24h (hier)
    const rain24h = d.daily?.precipitation_sum?.[0] || 0;
    const rainToday = d.daily?.precipitation_sum?.[1] || 0;

    // Pr√©visions prochaines heures
    const now = new Date();
    const currentHour = now.getHours();
    const hours = d.hourly.time.slice(24, 24+12); // next 12h from today
    const forecastItems = hours.slice(currentHour, currentHour+6).map((t, i) => {
      const idx = 24 + currentHour + i;
      const h = new Date(t).getHours();
      const ft = Math.round(d.hourly.temperature_2m[idx] || 0);
      const fp = d.hourly.precipitation[idx] || 0;
      const fc = WMO_CODES[d.hourly.weathercode[idx]] || '';
      const fi = fc.split(' ')[0] || 'üå°Ô∏è';
      return `<div class="meteo-forecast-item">
        <div class="f-hour">${h}h</div>
        <div>${fi}</div>
        <div class="f-temp">${ft}¬∞</div>
        ${fp > 0 ? `<div class="f-rain">${fp}mm</div>` : ''}
      </div>`;
    }).join('');

    let rainAlert = '';
    if (rain24h >= 10) {
      rainAlert = `<div class="meteo-rain-alert">üåßÔ∏è ${rain24h.toFixed(1)}mm tomb√©s hier ‚Äî arrosage probablement inutile aujourd&#39;hui</div>`;
    } else if (rain24h >= 5) {
      rainAlert = `<div class="meteo-rain-alert">üíß ${rain24h.toFixed(1)}mm hier ‚Äî v√©rifier humidit√© sol avant arrosage</div>`;
    }
    if (rainToday >= 5) {
      rainAlert += `<div class="meteo-rain-alert">üå¶Ô∏è ${rainToday.toFixed(1)}mm pr√©vus aujourd&#39;hui</div>`;
    }

    const meteoHtml = `
      <div class="meteo-icon">${icon}</div>
      <div class="meteo-main">
        <div class="meteo-temp">${temp}¬∞C</div>
        <div class="meteo-desc">${desc.split(' ').slice(1).join(' ')} ¬∑ Neuvic</div>
      </div>
      <div class="meteo-details">
        <div class="meteo-detail"><div class="meteo-detail-val">${hum}%</div><div class="meteo-detail-lbl">Humidit√©</div></div>
        <div class="meteo-detail"><div class="meteo-detail-val">${wind}km/h</div><div class="meteo-detail-lbl">Vent</div></div>
        <div class="meteo-detail"><div class="meteo-detail-val">${rain24h.toFixed(1)}mm</div><div class="meteo-detail-lbl">Pluie hier</div></div>
        <div class="meteo-detail"><div class="meteo-detail-val">${precip}mm</div><div class="meteo-detail-lbl">Maintenant</div></div>
      </div>
      ${rainAlert}
      <div class="meteo-forecast">${forecastItems}</div>`;
    widget.innerHTML = meteoHtml;
    const w2 = document.getElementById('meteoWidget2'); if(w2) w2.innerHTML = meteoHtml;

  } catch(e) {
    if (widget) widget.innerHTML = `<span class="meteo-loading">‚ö† M√©t√©o indisponible (${e.message})</span>`;
  }
}

function getMeteoContext() {
  if (!meteoData) return 'M√©t√©o non disponible.';
  const cur = meteoData.current;
  const rain24h = meteoData.daily?.precipitation_sum?.[0] || 0;
  const rainToday = meteoData.daily?.precipitation_sum?.[1] || 0;
  const tmax = meteoData.daily?.temperature_2m_max?.[1] || cur.temperature_2m;
  const tmin = meteoData.daily?.temperature_2m_min?.[1] || cur.temperature_2m;
  const desc = WMO_CODES[cur.weathercode] || 'Variable';
  return `M√âT√âO NEUVIC AUJOURD'HUI:
- Conditions: ${desc}
- Temp√©rature actuelle: ${Math.round(cur.temperature_2m)}¬∞C (min ${Math.round(tmin)}¬∞C / max ${Math.round(tmax)}¬∞C)
- Humidit√© air: ${cur.relative_humidity_2m}%
- Vent: ${Math.round(cur.windspeed_10m)} km/h
- Pr√©cipitations hier (24h): ${rain24h.toFixed(1)} mm
- Pr√©cipitations pr√©vues aujourd&#39;hui: ${rainToday.toFixed(1)} mm
${rain24h >= 10 ? '‚ö† PLUIE SIGNIFICATIVE HIER: adapter les recommandations arrosage en cons√©quence' : ''}
${rainToday >= 10 ? 'PLUIE PREVUE AUJOURDHUI: adapter les activites exterieures' : ''}`;
}

// ==================== √âTAT DE LA FERME ====================
const etatFields = [
  'etat_vers_kg','etat_vers_cond','etat_vers_alim','etat_vers_stock',
  'etat_compost_andains','etat_compost_mat',
  'etat_anim_volailles','etat_anim_autres','etat_anim_rotation','etat_anim_oeufs',
  'etat_huerto_cultivos','etat_huerto_serre','etat_huerto_riego','etat_huerto_problemas',
  'etat_infra_ibcs','etat_infra_notas'
];

async function loadEtat() {
  // Solo cargar si hay token activo
  if (!sessionStorage.getItem('nv_token')) {
    const saved = JSON.parse(localStorage.getItem('nv_etat') || '{}');
    etatFields.forEach(id => {
      const el = document.getElementById(id);
      if (el && saved[id]) el.value = saved[id];
    });
    updateContextBadge();
    return;
  }
  // MySQL es la fuente de verdad ‚Äî localStorage solo es cache offline
  // Primero limpiar campos para evitar datos viejos
  etatFields.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  try {
    const data = await api('etat_get');
    if (data && typeof data === 'object' && Object.keys(data).length > 0) {
      etatFields.forEach(id => {
        const el = document.getElementById(id);
        if (el && data[id] !== undefined) el.value = data[id];
      });
      // Actualizar cache local con datos del servidor
      localStorage.setItem('nv_etat', JSON.stringify(data));
    } else {
      // MySQL vac√≠o ‚Äî cargar cache local si existe
      const saved = JSON.parse(localStorage.getItem('nv_etat') || '{}');
      etatFields.forEach(id => {
        const el = document.getElementById(id);
        if (el && saved[id]) el.value = saved[id];
      });
    }
  } catch(e) {
    // Sin conexi√≥n ‚Äî fallback a cache local
    const saved = JSON.parse(localStorage.getItem('nv_etat') || '{}');
    etatFields.forEach(id => {
      const el = document.getElementById(id);
      if (el && saved[id]) el.value = saved[id];
    });
    console.warn('loadEtat fallback localStorage:', e.message);
  }
  updateContextBadge();
}

async function saveEtat() {
  const data = {};
  etatFields.forEach(id => {
    const el = document.getElementById(id);
    if (el) data[id] = el.value;
  });
  // Save to localStorage as immediate cache
  localStorage.setItem('nv_etat', JSON.stringify(data));
  updateContextBadge();
  const btn = document.getElementById('etatSaveBtn');
  if (btn) { btn.textContent = '‚è≥ Guardando...'; }
  try {
    await api('etat_set', data);
    if (btn) { btn.textContent = '‚úì Guardado y sincronizado!'; btn.classList.add('saved'); setTimeout(() => { btn.textContent = 'üíæ Guardar estado de la granja'; btn.classList.remove('saved'); }, 2500); }
  } catch(e) {
    if (btn) { btn.textContent = '‚ö† Guardado local (sin sync)'; btn.classList.add('saved'); setTimeout(() => { btn.textContent = 'üíæ Guardar estado de la granja'; btn.classList.remove('saved'); }, 2500); }
  }
}

function updateContextBadge() {
  const saved = JSON.parse(localStorage.getItem('nv_etat') || '{}');
  const hasData = Object.values(saved).some(v => v && v.trim());
  const badge = document.getElementById('contextBadge');
  if (badge) badge.style.display = hasData ? 'inline-flex' : 'none';
}

function getEtatContext(domain) {
  // Read from localStorage cache (synced from MySQL on load)
  const saved = JSON.parse(localStorage.getItem('nv_etat') || '{}');
  const get = id => saved[id] ? saved[id].trim() : '';
  const sections = {
    vers: `√âTAT ACTUEL LOMBRICOMPOSTI√àRE:
- Kg de vers: ${get('etat_vers_kg') || 'non renseign√©'}
- Conditions: ${get('etat_vers_cond') || 'non renseign√©'}
- Derni√®re alimentation: ${get('etat_vers_alim') || 'non renseign√©'}
- Stock lombricompost pr√™t: ${get('etat_vers_stock') || 'non renseign√©'}`,
    compost: `√âTAT ACTUEL COMPOST:
- Andains en cours: ${get('etat_compost_andains') || 'non renseign√©'}
- Mati√®res disponibles: ${get('etat_compost_mat') || 'non renseign√©'}`,
    animaux: `√âTAT ACTUEL ANIMAUX:
- Volailles: ${get('etat_anim_volailles') || 'non renseign√©'}
- Brebis & lapins: ${get('etat_anim_autres') || 'non renseign√©'}
- Rotation parcelles: ${get('etat_anim_rotation') || 'non renseign√©'}
- Production ≈ìufs: ${get('etat_anim_oeufs') || 'non renseign√©'}`,
    huerto: `√âTAT ACTUEL POTAGER:
- Cultures en place: ${get('etat_huerto_cultivos') || 'non renseign√©'}
- Serre √† semis: ${get('etat_huerto_serre') || 'non renseign√©'}
- Dernier arrosage: ${get('etat_huerto_riego') || 'non renseign√©'}
- Probl√®mes d√©tect√©s: ${get('etat_huerto_problemas') || 'non renseign√©'}
${getHuertoContext()}`
  };
  const infra = get('etat_infra_ibcs') || get('etat_infra_notas') ? 
    `\nINFRASTRUCTURE & G√âN√âRAL:
- IBCs/bacs: ${get('etat_infra_ibcs') || 'non renseign√©'}
- Notes: ${get('etat_infra_notas') || 'non renseign√©'}` : '';
  return (sections[domain] || '') + infra;
}




// ==================== HUERTO PHOTO ANALYSIS ====================
let huertoPhotoBase64 = null;
let huertoPhotoType = 'image/jpeg';
let lastHuertoAnalysis = '';

function handlePhotoHuerto(input) {
  const file = input.files[0];
  if (!file) return;
  huertoPhotoType = file.type || 'image/jpeg';
  const reader = new FileReader();
  reader.onload = (e) => {
    const dataUrl = e.target.result;
    huertoPhotoBase64 = dataUrl.split(',')[1];
    const preview = document.getElementById('photoPreviewHuerto');
    const wrap = document.getElementById('photoPreviewWrapHuerto');
    const btn = document.getElementById('btnPhotoHuerto');
    const lbl = document.getElementById('photoLabelHuerto');
    if (preview) preview.src = dataUrl;
    if (wrap) wrap.classList.add('visible');
    if (btn) btn.classList.add('has-photo');
    if (lbl) lbl.textContent = 'üì∑ ' + file.name.substring(0, 25);
  };
  reader.readAsDataURL(file);
}

function removePhotoHuerto() {
  huertoPhotoBase64 = null;
  const els = ['photoPreviewHuerto','photoPreviewWrapHuerto','btnPhotoHuerto','photoLabelHuerto','photoInputHuerto'];
  const preview = document.getElementById('photoPreviewHuerto');
  const wrap = document.getElementById('photoPreviewWrapHuerto');
  const btn = document.getElementById('btnPhotoHuerto');
  const lbl = document.getElementById('photoLabelHuerto');
  const input = document.getElementById('photoInputHuerto');
  if (preview) preview.src = '';
  if (wrap) wrap.classList.remove('visible');
  if (btn) btn.classList.remove('has-photo');
  if (lbl) lbl.textContent = 'Foto del huerto o parcela';
  if (input) input.value = '';
}

async function analyzeHuertoPhoto() {
  const query = document.getElementById('huertoPhotoQuery')?.value.trim() || '';
  const panel = document.getElementById('huertoPhotoPanel');
  const body = document.getElementById('huertoPhotoBody');
  const footer = document.getElementById('huertoPhotoFooter');
  const btn = document.getElementById('btnAnalyzeHuerto');

  if (!huertoPhotoBase64 && !query) {
    if (body) body.textContent = 'A√±ade una foto o escribe una pregunta sobre el huerto.';
    if (panel) panel.classList.add('visible');
    return;
  }

  if (panel) panel.classList.add('visible');
  if (body) body.innerHTML = '<div class="thinking"><div class="thinking-dots"><span></span><span></span><span></span></div> Analizando...</div>';
  if (btn) btn.disabled = true;
  if (footer) footer.style.display = 'none';

  const huertoCtx = getHuertoContext();
  const systemHuerto = `Eres el especialista en POTAGER de NosVers, granja agroecologica en Dordona.
Filosofia: suelo vivo (Elaine Ingham), sin laboreo, JADAM, biodynamie (Maria Thun/Christofleau), sintrop√≠a (G√∂tsch), La Tanina, permacultura.
Huerto actual: ${huertoCtx}
Analiza lo que ves en la foto con ojo de experto agroecologico. Identifica: cultivos, estado sanitario, familias botanicas, plagas/enfermedades, oportunidades de mejora. Proporciona recomendaciones concretas alineadas con la filosofia NosVers. Si puedes deducir informacion para el plano (que cultivo es, en que parcela podria estar, familia botanica) indicalo al final en formato: DATOS PARA PLANO: cultivo X - familia Y - estado Z. Responde en ESPANOL.`;

  const userContent = [];
  if (huertoPhotoBase64) {
    userContent.push({ type: 'image', source: { type: 'base64', media_type: huertoPhotoType, data: huertoPhotoBase64 }});
  }
  userContent.push({ type: 'text', text: query || 'Analiza esta foto del huerto NosVers y dame tu diagn√≥stico experto.' });

  try {
    const token = sessionStorage.getItem('nv_token') || '';
    const resp = await fetch(API_URL + '?action=agente', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-App-Token': token },
      body: JSON.stringify({ system: systemHuerto, user_content: userContent })
    });
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    if (data.error) throw new Error(typeof data.error === 'object' ? data.error.message : data.error);
    lastHuertoAnalysis = data.content.map(b => b.text || '').join('');
    if (body) body.textContent = lastHuertoAnalysis;
    if (footer) footer.style.display = '';
  } catch(e) {
    if (body) body.textContent = 'Error: ' + e.message;
  } finally {
    if (btn) btn.disabled = false;
  }
}

function saveHuertoAnalysis() {
  if (!lastHuertoAnalysis) return;
  const date = new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
  const saved = JSON.parse(localStorage.getItem('nv_etat') || '{}');
  saved['etat_huerto_problemas'] = '[An√°lisis ' + date + '] ' + lastHuertoAnalysis.substring(0, 400) + '\n\n' + (saved['etat_huerto_problemas'] || '');
  localStorage.setItem('nv_etat', JSON.stringify(saved));
  const el = document.getElementById('etat_huerto_problemas');
  if (el) el.value = saved['etat_huerto_problemas'];
  api('etat_set', { etat_huerto_problemas: saved['etat_huerto_problemas'] }).catch(() => {});
  alert('‚úì An√°lisis guardado en el estado del huerto');
}

function copyHuertoAnalysis() {
  if (lastHuertoAnalysis) navigator.clipboard.writeText(lastHuertoAnalysis).catch(() => {});
}

// ==================== PLANO HUERTO ====================
const FAMILIAS = {
  'solanacees':    { label: 'Solanac√©es',    ex: 'Tomate, poivron, aubergine, pomme de terre' },
  'cucurbitacees': { label: 'Cucurbitac√©es', ex: 'Courgette, concombre, melon, courge' },
  'liliacees':     { label: 'Liliac√©es',     ex: 'Oignon, ail, poireau, √©chalote' },
  'legumineuses':  { label: 'L√©gumineuses',  ex: 'Haricot, pois, f√®ve, lentille' },
  'cruciferes':    { label: 'Crucif√®res',    ex: 'Chou, radis, navet, roquette' },
  'apiacees':      { label: 'Apiac√©es',      ex: 'Carotte, persil, fenouil, c√©leri' },
  'asteracees':    { label: 'Ast√©rac√©es',    ex: 'Laitue, artichaut, chicor√©e' },
  'chenopodiaceae':{ label: 'Ch√©nopodiac√©es',ex: '√âpinard, betterave, blette' },
  'poaceae':       { label: 'Poac√©es',       ex: 'Ma√Øs, engrais vert gramin√©es' },
  'autre':         { label: 'Autre/Mixte',   ex: 'Engrais vert, fleurs, aromates' },
  'vide':          { label: 'Vide/Repos',    ex: 'Parcelle en jach√®re ou pr√©paration' },
};

let parcelles = JSON.parse(localStorage.getItem('nv_parcelles') || '[]');
let editingParcelle = null;

function saveParcelles() {
  localStorage.setItem('nv_parcelles', JSON.stringify(parcelles));
}

function renderHuerto() {
  const grid = document.getElementById('huertoGrid');
  const count = document.getElementById('huertoCount');
  if (!grid) return;

  const actives = parcelles.filter(p => p.cultivo && p.cultivo !== 'Vide');
  if (count) count.textContent = actives.length + ' parcelles cultiv√©es';

  // Check rotation warnings
  checkRotations();

  grid.innerHTML = parcelles.map((p, i) => {
    const fam = p.famille || 'vide';
    const famLabel = FAMILIAS[fam]?.label || fam;
    const isEmpty = !p.cultivo || p.cultivo === 'Vide' || fam === 'vide';
    const rotAlert = p.rotation_warning ? '<span class="parcelle-alerte" title="Rotation conseill√©e">‚ö†Ô∏è</span>' : '';
    return `<div class="parcelle ${isEmpty ? 'vide' : ''}" onclick="editParcelle(${i})">
      ${rotAlert}
      <div class="parcelle-num">Parcelle ${p.nom || (i+1)}</div>
      <div class="parcelle-cultivo">${p.cultivo || '+ Ajouter'}</div>
      ${!isEmpty ? `<span class="parcelle-famille fam-${fam}">${famLabel}</span>` : ''}
      ${p.date_semis ? `<div class="parcelle-date">Semis: ${p.date_semis}</div>` : ''}
      ${p.statut ? `<div class="parcelle-date">${p.statut}</div>` : ''}
    </div>`;
  }).join('') + `<div class="parcelle vide" onclick="addParcelle()" style="display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:var(--texte-doux)">+</div>`;
}

function checkRotations() {
  const warnings = [];
  parcelles.forEach((p, i) => {
    if (!p.famille || p.famille === 'vide') return;
    // Check historique for same family in last 2 seasons
    if (p.historique && p.historique.length > 0) {
      const lastSeason = p.historique[p.historique.length - 1];
      if (lastSeason.famille === p.famille) {
        p.rotation_warning = true;
        warnings.push(`Parcelle ${p.nom || (i+1)}: ${FAMILIAS[p.famille]?.label} d√©j√† cultiv√©e la saison derni√®re`);
      } else {
        p.rotation_warning = false;
      }
    }
  });

  const warnEl = document.getElementById('rotationWarning');
  const warnText = document.getElementById('rotationWarningText');
  if (warnings.length > 0 && warnEl && warnText) {
    warnEl.style.display = 'block';
    warnText.innerHTML = warnings.map(w => `‚Ä¢ ${w}`).join('<br>');
  } else if (warnEl) {
    warnEl.style.display = 'none';
  }
}

function addParcelle() {
  editingParcelle = null;
  openModalParcelle(null, parcelles.length);
}

function editParcelle(idx) {
  editingParcelle = idx;
  openModalParcelle(parcelles[idx], idx);
}

function openModalHuerto() {
  addParcelle();
}

function openModalParcelle(p, idx) {
  const title = document.getElementById('modalTitle');
  const body = document.getElementById('modalBody');
  if (!title || !body) return;

  title.textContent = p ? `Parcelle ${p.nom || (idx+1)}` : 'Nouvelle parcelle';

  const famOptions = Object.entries(FAMILIAS).map(([k, v]) =>
    `<option value="${k}" ${p?.famille === k ? 'selected' : ''}>${v.label}</option>`
  ).join('');

  const hist = p?.historique?.length > 0 ? `
    <div class="parcelle-historique">
      <strong>Historique rotations:</strong>
      ${p.historique.map(h => `<div class="hist-item"><span>${h.saison}</span><span>${h.cultivo} ¬∑ ${FAMILIAS[h.famille]?.label || h.famille}</span></div>`).join('')}
    </div>` : '';

  body.innerHTML = `<div class="parcelle-form">
    <label>Nom / Num√©ro</label>
    <input id="pNom" value="${p?.nom || ''}" placeholder="Ex: A1, Bancal Nord, Serre...">
    <label>Cultivo actuel</label>
    <input id="pCultivo" value="${p?.cultivo || ''}" placeholder="Ex: Tomates cerises, Courgettes...">
    <label>Famille botanique</label>
    <select id="pFamille">${famOptions}</select>
    <label>Date de semis / plantation</label>
    <input id="pDate" type="date" value="${p?.date_semis || ''}">
    <label>Statut</label>
    <input id="pStatut" value="${p?.statut || ''}" placeholder="Ex: En fleur, R√©colte d√©but juillet...">
    <label>Notes</label>
    <textarea id="pNotes" rows="2" placeholder="Observations, traitements...">${p?.notes || ''}</textarea>
    ${hist}
    <div style="display:flex;gap:0.5rem;margin-top:1.2rem">
      <button class="btn-action btn-primary" style="flex:1" onclick="saveParcelle(${idx})">Sauvegarder</button>
      ${p ? `<button class="btn-action btn-secondary" onclick="archiveParcelle(${idx})">üì¶ Archiver saison</button>` : ''}
      ${p ? `<button class="btn-action btn-secondary" onclick="deleteParcelle(${idx})" style="color:#c0392b;border-color:#c0392b">Supprimer</button>` : ''}
    </div>
  </div>`;

  document.getElementById('overlay').classList.add('open');
}

function saveParcelle(idx) {
  const p = {
    nom: document.getElementById('pNom').value.trim(),
    cultivo: document.getElementById('pCultivo').value.trim(),
    famille: document.getElementById('pFamille').value,
    date_semis: document.getElementById('pDate').value,
    statut: document.getElementById('pStatut').value.trim(),
    notes: document.getElementById('pNotes').value.trim(),
    historique: parcelles[idx]?.historique || [],
    rotation_warning: false,
  };
  if (idx < parcelles.length) {
    parcelles[idx] = p;
  } else {
    parcelles.push(p);
  }
  saveParcelles();
  renderHuerto();
  closeModal();
}

function archiveParcelle(idx) {
  const p = parcelles[idx];
  if (!p.cultivo || p.cultivo === 'Vide') return;
  const saison = new Date().getFullYear() + ' S' + (new Date().getMonth() < 6 ? '1' : '2');
  if (!p.historique) p.historique = [];
  p.historique.push({ saison, cultivo: p.cultivo, famille: p.famille });
  if (p.historique.length > 4) p.historique.shift();
  // Reset current season
  p.cultivo = '';
  p.famille = 'vide';
  p.date_semis = '';
  p.statut = '';
  saveParcelles();
  renderHuerto();
  closeModal();
}

function deleteParcelle(idx) {
  if (confirm('Supprimer cette parcelle ?')) {
    parcelles.splice(idx, 1);
    saveParcelles();
    renderHuerto();
    closeModal();
  }
}

function resetHuerto() {
  if (confirm('Archiver toutes les parcelles pour nouvelle saison ?')) {
    const saison = new Date().getFullYear() + ' S' + (new Date().getMonth() < 6 ? '1' : '2');
    parcelles.forEach(p => {
      if (p.cultivo && p.cultivo !== 'Vide') {
        if (!p.historique) p.historique = [];
        p.historique.push({ saison, cultivo: p.cultivo, famille: p.famille });
        if (p.historique.length > 4) p.historique.shift();
        p.cultivo = ''; p.famille = 'vide'; p.date_semis = ''; p.statut = '';
      }
    });
    saveParcelles();
    renderHuerto();
  }
}

function getHuertoContext() {
  if (!parcelles.length) return '';
  const actives = parcelles.filter(p => p.cultivo && p.famille !== 'vide');
  if (!actives.length) return 'PLANO HUERTO: Sin parcelas registradas a√∫n.';

  const warnings = parcelles.filter(p => p.rotation_warning).map(p => p.nom || 'sin nombre');

  return `PLANO HUERTO ACTUAL (${actives.length} parcelles actives):
${actives.map(p => `- Parcelle ${p.nom || '?'}: ${p.cultivo} [${FAMILIAS[p.famille]?.label || p.famille}]${p.date_semis ? ' ¬∑ Semis: '+p.date_semis : ''}${p.statut ? ' ¬∑ '+p.statut : ''}`).join('\n')}
${warnings.length > 0 ? '\n‚ö† ROTATIONS A RESPECTER: ' + warnings.join(', ') : ''}`;
}



// ==================== DIRECTOR DE OPERACIONES ====================
let directorLastResponse = '';

function getJournalSummary() {
  if (!journal || !journal.length) return 'Sin actividad registrada en el journal.';
  const recent = journal.slice(0, 10);
  return 'ACTIVIDAD RECIENTE (journal):\n' + recent.filter(e => e && (e.ts || e.created_at)).map(e => {
    const dt = new Date(e.ts || e.created_at);
    const d = isNaN(dt) ? '' : dt.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }) + ' ';
    return `- ${d}[${e.domain || 'general'}] ${e.action}${e.completed ? ' (completado)' : ''}`;
  }).join('\n');
}

function getAllEtatContext() {
  // Read from localStorage cache (synced from MySQL on load)
  const saved = JSON.parse(localStorage.getItem('nv_etat') || '{}');
  const get = id => saved[id] ? saved[id].trim() : 'no indicado';
  return `ESTADO COMPLETO DE LA GRANJA:
LOMBRICOMPOSTIERE:
- Kg de vers: ${get('etat_vers_kg')}
- Condiciones: ${get('etat_vers_cond')}
- Ultima alimentacion: ${get('etat_vers_alim')}
- Stock listo: ${get('etat_vers_stock')}
COMPOST:
- Andains: ${get('etat_compost_andains')}
- Materias disponibles: ${get('etat_compost_mat')}
ANIMAUX:
- Volailles: ${get('etat_anim_volailles')}
- Brebis/lapins: ${get('etat_anim_autres')}
- Rotacion parcelas: ${get('etat_anim_rotation')}
- Produccion huevos: ${get('etat_anim_oeufs')}
POTAGER:
- Cultivos en marcha: ${get('etat_huerto_cultivos')}
- Semillero/serre: ${get('etat_huerto_serre')}
- Ultimo riego: ${get('etat_huerto_riego')}
- Problemas detectados: ${get('etat_huerto_problemas')}
INFRAESTRUCTURA:
- IBCs/bacs: ${get('etat_infra_ibcs')}
- Notas generales: ${get('etat_infra_notas')}`;
}

async function launchDirector() {
  const extras = document.getElementById('directorInput')?.value.trim() || '';
  const body = document.getElementById('directorBody');
  const meta = document.getElementById('directorMeta');
  const btnDone = document.getElementById('btnDirectorDone');
  const lastEl = document.getElementById('directorLast');

  if (body) body.innerHTML = '<div class="director-thinking"><div class="thinking-dots"><span></span><span></span><span></span></div> Analizando la granja y preparando el briefing del dia...</div>';
  if (meta) meta.textContent = 'Generando...';
  if (btnDone) btnDone.style.display = 'none';

  const today = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
  const meteoCtx = getMeteoContext();
  const allEtat = getAllEtatContext();
  const journalCtx = getJournalSummary();
  const huertoCtx = getHuertoContext();

  const systemDirector = `Eres el DIRECTOR DE OPERACIONES de la granja agroecologica NosVers en Dordona, Francia.
La granja es gestionada por Africa (responsable principal, todos los dias) y Angel (apoyo tecnico fines de semana).
Animales: gallinas ponedoras, canards coureurs indiens (control limaces), lapins, brebis Cameroun.
Productos: lombricompost Eisenia, the de lombric, venta de lombrices, kits de cultivo.

FILOSOFIA (NO NEGOCIABLE): Suelo vivo (Elaine Ingham), sin laboreo (Fukuoka/no-dig), JADAM (SMJ/FPJ/FAA/LAB), biodynamie (Maria Thun/calendrier/BD500-501/Christofleau electrocultura), sintrop√≠a (G√∂tsch), La Tanina, permacultura, animales integrados al ecosistema.

TU ROL: Eres el unico que genera ordenes de trabajo. Los 4 especialistas (lombrices, compost, animaux, potager) solo dan consejo tecnico cuando se les consulta.

COMO HACER EL BRIEFING:
1. Saludo breve con fecha y condiciones del dia (clima, tipo de dia biodinamico si lo sabes)
2. ALERTAS PRIORITARIAS: problemas urgentes detectados en el estado de la granja (temperatura lombrices critica, animales enfermos, riego urgente por calor, etc)
3. PLAN DEL DIA - tareas ordenadas por prioridad y hora:
   Cada tarea: [hora] AREA - accion concreta - parametro medible - criterio de exito
4. COORDINACIONES: tareas que impactan varios dominios (ej: fumier animaux -> compost -> lombricompost)
5. NOTA FINAL: 1 cosa a observar hoy que alimentara el contexto de manana

Responde SIEMPRE en ESPANOL. Tono directo de jefe de operaciones de campo. Sin florituras. Maximo 600 palabras.`;

  const userMsg = `Fecha: ${today}

${meteoCtx}

${allEtat}

${huertoCtx}

${journalCtx}
${extras ? '\nCONTEXTO ADICIONAL HOY: ' + extras : ''}

Genera el briefing completo del dia para la granja NosVers.`;

  try {
    const token = sessionStorage.getItem('nv_token') || '';
    const resp = await fetch(API_URL + '?action=agente', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-App-Token': token },
      body: JSON.stringify({ system: systemDirector, user: userMsg })
    });
    if (!resp.ok) { const e = await resp.text(); throw new Error('HTTP ' + resp.status + ' - ' + e); }
    const data = await resp.json();
    if (data.error) throw new Error(typeof data.error === 'object' ? data.error.message : data.error);
    if (!data.content) throw new Error('Respuesta vacia');
    directorLastResponse = data.content.map(b => b.text || '').join('');

    if (body) body.textContent = directorLastResponse;
    if (meta) meta.textContent = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
    if (btnDone) btnDone.style.display = '';
    if (lastEl) lastEl.textContent = 'Ultimo briefing: ' + new Date().toLocaleString('es-ES', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });

    // Save to journal
    addJournalEntry('director', 'Briefing del dia generado', false);

  } catch(e) {
    if (body) body.textContent = 'Error: ' + e.message;
    if (meta) meta.textContent = 'Error';
  }
}

function markDirectorDone() {
  const btn = document.getElementById('btnDirectorDone');
  if (btn) { btn.textContent = '‚úì Ejecutado!'; btn.classList.add('done'); }
  addJournalEntry('director', 'Plan del dia ejecutado', true);
}

function copyDirector() {
  if (directorLastResponse) {
    navigator.clipboard.writeText(directorLastResponse).catch(() => {});
    const btns = document.querySelectorAll('.btn-director-secondary');
    btns.forEach(b => { if (b.textContent.includes('Copiar')) { const o = b.textContent; b.textContent = '‚úì Copiado'; setTimeout(() => b.textContent = o, 1500); }});
  }
}

function selectAgent(domain) {
  activeAgent = domain;
  document.querySelectorAll('.agent-specialist').forEach(c => c.classList.remove('active'));
  const card = document.getElementById('card-' + domain);
  if (card) card.classList.add('active');
  const btnQ = document.getElementById('btnQuery');
  if (btnQ) btnQ.disabled = false;

  const labels = { vers: 'Especialista Lombricompost', compost: 'Especialista Compost', animaux: 'Especialista Animaux', huerto: 'Especialista Potager' };
  const colors = { vers: '#6b3a2a', compost: '#c45c00', animaux: '#7b3f00', huerto: '#2e6b30' };
  const icons = { vers: 'ü™±', compost: 'üçÇ', animaux: 'üêì', huerto: 'üåø' };
  const col = colors[domain] || '#666';
  const domEl = document.getElementById('respDomain');
  if (domEl) domEl.innerHTML = `<span class="resp-domain-dot" style="background:${col}"></span> ${icons[domain]} ${labels[domain]}`;
}

// ==================== DUAL MODE ====================
let currentMode = 'ordres';

function setMode(mode) {
  currentMode = mode;
  document.getElementById('modeOrdres').classList.toggle('active', mode === 'ordres');
  document.getElementById('modeConseil').classList.toggle('active', mode === 'conseil');
  const btnDone = document.getElementById('btnDone');
  const btnSave = document.getElementById('btnSaveConseil');
  if (btnDone) btnDone.style.display = mode === 'ordres' ? '' : 'none';
  if (btnSave) btnSave.style.display = mode === 'conseil' ? '' : 'none';
  const qi = document.getElementById('queryInput');
  if (qi) qi.placeholder = mode === 'ordres'
    ? 'Precisi√≥n opcional: temperatura actual, problema observado, disponibilidad...'
    : 'Tu pregunta o descripci√≥n del problema (ej: mis lombrices huyen, esta planta tiene manchas...)';
}

function saveConseilToContext() {
  if (!lastResp || !activeAgent) return;
  const saved = JSON.parse(localStorage.getItem('nv_etat') || '{}');
  const date = new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
  const key = 'etat_' + (activeAgent === 'vers' ? 'vers_cond' :
                          activeAgent === 'compost' ? 'compost_andains' :
                          activeAgent === 'animaux' ? 'anim_volailles' : 'huerto_problemas');
  const prev = saved[key] || '';
  saved[key] = '[Diagn√≥stico ' + date + '] ' + lastResp.substring(0, 300) + '...\n\n' + prev;
  localStorage.setItem('nv_etat', JSON.stringify(saved));
  const el = document.getElementById(key);
  if (el) el.value = saved[key];
  // Sync to MySQL
  const syncData = {};
  syncData[key] = saved[key];
  api('etat_set', syncData).catch(() => {});
  const badge = document.getElementById('conseilSavedBadge');
  if (badge) { badge.classList.add('visible'); setTimeout(() => badge.classList.remove('visible'), 3000); }
  updateContextBadge();
}

// ==================== PHOTO HANDLING ====================
let currentPhotoBase64 = null;
let currentPhotoType = 'image/jpeg';

function handlePhoto(input) {
  const file = input.files[0];
  if (!file) return;
  currentPhotoType = file.type || 'image/jpeg';
  const reader = new FileReader();
  reader.onload = (e) => {
    const dataUrl = e.target.result;
    currentPhotoBase64 = dataUrl.split(',')[1];
    const preview = document.getElementById('photoPreview');
    const wrap = document.getElementById('photoPreviewWrap');
    const btn = document.getElementById('btnPhoto');
    const lbl = document.getElementById('photoLabel');
    if (preview) preview.src = dataUrl;
    if (wrap) wrap.classList.add('visible');
    if (btn) btn.classList.add('has-photo');
    if (lbl) lbl.textContent = 'üì∑ ' + file.name.substring(0, 25);
  };
  reader.readAsDataURL(file);
}

function removePhoto() {
  currentPhotoBase64 = null;
  const preview = document.getElementById('photoPreview');
  const wrap = document.getElementById('photoPreviewWrap');
  const btn = document.getElementById('btnPhoto');
  const lbl = document.getElementById('photoLabel');
  const input = document.getElementById('photoInput');
  if (preview) preview.src = '';
  if (wrap) wrap.classList.remove('visible');
  if (btn) btn.classList.remove('has-photo');
  if (lbl) lbl.textContent = 'Ajouter une photo (optionnel)';
  if (input) input.value = '';
}

</script>

</body>
</html>
